
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Kent's Blog</title>
  <meta name="author" content="Kent">

  
  <meta name="description" content="Java Persistence API(JPA) Where to put the persistence.xml for web application → WEB-INF/classes/META-INF/persistence.xml
for jar →
for maven main &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.kent-chiu.com/blog/page/3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Kent's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-39152849-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Kent's Blog</a></h1>
  
    <h2>Kent的學習筆記</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.kent-chiu.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/12/jpa_101/">JPA 101</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-12T00:00:00+08:00" pubdate data-updated="true">Jul 12<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/07/12/jpa_101/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Java Persistence API(JPA)</p>

<h1>Where to put the persistence.xml</h1>

<ul>
<li>for web application → WEB-INF/classes/META-INF/persistence.xml</li>
<li>for jar →</li>
<li>for maven main folder → src/main/resource/META-INF/persistence.xml</li>
<li>for maven test folder → src/test/resource/META-INF/persistence.xml</li>
</ul>


<p>If uses maven structure in Eclipse IDE, main resource and test resource
would complied to same directory(the build directory), we should avoid
using the same <strong>persistence-unit</strong> name in test and main resources</p>

<h1>presitence.xml</h1>

<h3>Hibernate</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
</span><span class='line'>&lt;persistence version="1.0" xmlns="http://java.sun.com/xml/ns/persistence" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_1_0.xsd"&gt;
</span><span class='line'>    &lt;persistence-unit name="entity" transaction-type="RESOURCE_LOCAL"&gt;
</span><span class='line'>        &lt;provider&gt;org.hibernate.ejb.HibernatePersistence&lt;/provider&gt;
</span><span class='line'>        &lt;class&gt;com.kent.MyClass&lt;/class&gt;
</span><span class='line'>        &lt;properties&gt;
</span><span class='line'>            &lt;property name="hibernate.hbm2ddl.auto" value="update" /&gt;
</span><span class='line'>            &lt;property name="hibernate.dialect" value="org.hibernate.dialect.MySQLDialect" /&gt;
</span><span class='line'>            &lt;property name="hibernate.connection.driver_class" value="com.mysql.jdbc.Driver" /&gt;
</span><span class='line'>            &lt;property name="hibernate.connection.url" value="jdbc:mysql://localhost/database_name" /&gt;
</span><span class='line'>            &lt;property name="hibernate.connection.username" value="root" /&gt;
</span><span class='line'>            &lt;property name="hibernate.connection.password" value="" /&gt;
</span><span class='line'>                        &lt;property name="hibernate.show_sql" value="true" /&gt;
</span><span class='line'>        &lt;/properties&gt;
</span><span class='line'>    &lt;/persistence-unit&gt;
</span><span class='line'>&lt;/persistence&gt;</span></code></pre></td></tr></table></div></figure>


<p>set property bernate.show_sql to true to output HSQL → SQL in console.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;property name="hibernate.dialect" value="org.hibernate.dialect.MySQLDialect" /&gt;
</span><span class='line'>&lt;property name="hibernate.connection.driver_class" value="com.mysql.jdbc.Driver" /&gt;
</span><span class='line'>&lt;property name="hibernate.connection.url" value="jdbc:mysql://localhost/database_name" /&gt;</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;property name="hibernate.connection.url" value="jdbc:hsqldb:mem:database_name"/&gt;
</span><span class='line'>&lt;property name="hibernate.connection.driver_class" value="org.hsqldb.jdbcDriver"/&gt;
</span><span class='line'>&lt;property name="hibernate.dialect" value="org.hibernate.dialect.HSQLDialect"/&gt;</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;property name="hibernate.connection.url" value="jdbc:derby:memory:database_name"/&gt;
</span><span class='line'>&lt;property name="hibernate.connection.driver_class" value="org.apache.derby.jdbc.EmbeddedDriver"/&gt;
</span><span class='line'>&lt;property name="hibernate.dialect" value="org.hibernate.dialect.DerbyDialect"/&gt;</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;property name="hibernate.connection.url" value="jdbc:postgresql://localhost:5432/databaseName"/&gt;
</span><span class='line'>&lt;property name="hibernate.connection.driver_class" value="org.postgresql.Driver"/&gt;
</span><span class='line'>&lt;property name="hibernate.dialect" value="org.hibernate.dialect.PostgreSQLDialect"/&gt;</span></code></pre></td></tr></table></div></figure>


<p>MySQL encoding issue. If you encountered encoding issue when result set
contains CJK code, you can add this property to url connection string.
<code>?useUnicode=true&amp;amp;characterEncoding=UTF-8</code> ex:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  jdbc:mysql://localhost/database_name?useUnicode=true&amp;characterEncoding=UTF-8</span></code></pre></td></tr></table></div></figure>


<h3>EclipseLink - MySQL</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
</span><span class='line'>&lt;persistence version="1.0" xmlns="http://java.sun.com/xml/ns/persistence" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_1_0.xsd"&gt;
</span><span class='line'>    &lt;persistence-unit name="entity" transaction-type="RESOURCE_LOCAL"&gt;
</span><span class='line'>    &lt;provider&gt;org.eclipse.persistence.jpa.PersistenceProvider&lt;/provider&gt;
</span><span class='line'>        &lt;class&gt;com.kent.MyClass&lt;/class&gt;
</span><span class='line'>        &lt;properties&gt;
</span><span class='line'>            &lt;property name="eclipselink.target-database" value="MYSQL"/&gt;
</span><span class='line'>            &lt;property name="eclipselink.jdbc.url" value="jdbc:mysql://localhost/database_name"/&gt;
</span><span class='line'>            &lt;property name="eclipselink.jdbc.driver" value="com.mysql.jdbc.Driver"/&gt;
</span><span class='line'>            &lt;property name="eclipselink.jdbc.user" value="root"/&gt;
</span><span class='line'>            &lt;property name="eclipselink.jdbc.password" value=""/&gt;
</span><span class='line'>            &lt;property name="eclipselink.ddl-generation" value="update-tables"/&gt;
</span><span class='line'>            &lt;property name="eclipselink.logging.level" value="SEVERE"/&gt;
</span><span class='line'>        &lt;/properties&gt;
</span><span class='line'>    &lt;/persistence-unit&gt;
</span><span class='line'>&lt;/persistence&gt;</span></code></pre></td></tr></table></div></figure>


<h3>EclipseLink - HSQL</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
</span><span class='line'>&lt;persistence version="1.0" xmlns="http://java.sun.com/xml/ns/persistence" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_1_0.xsd"&gt;
</span><span class='line'>    &lt;persistence-unit name="entity" transaction-type="RESOURCE_LOCAL"&gt;
</span><span class='line'>    &lt;provider&gt;org.eclipse.persistence.jpa.PersistenceProvider&lt;/provider&gt;
</span><span class='line'>        &lt;class&gt;com.kent.MyClass&lt;/class&gt;
</span><span class='line'>        &lt;properties&gt;
</span><span class='line'>            &lt;property name="eclipselink.target-database" value="HSQL"/&gt;
</span><span class='line'>            &lt;property name="eclipselink.jdbc.url" value="jdbc:hsqldb:mem:database_name"/&gt;
</span><span class='line'>            &lt;property name="eclipselink.jdbc.driver" value="org.hsqldb.jdbcDriver"/&gt;
</span><span class='line'>            &lt;property name="eclipselink.jdbc.user" value="sa"/&gt;
</span><span class='line'>            &lt;property name="eclipselink.jdbc.password" value=""/&gt;
</span><span class='line'>            &lt;property name="eclipselink.ddl-generation" value="create-tables"/&gt;
</span><span class='line'>            &lt;property name="eclipselink.logging.level" value="SEVERE"/&gt;
</span><span class='line'>        &lt;/properties&gt;
</span><span class='line'>    &lt;/persistence-unit&gt;
</span><span class='line'>&lt;/persistence&gt;</span></code></pre></td></tr></table></div></figure>


<h1>Properties</h1>

<p>EclipseLink does NOT support the property <code>show sql</code> like hibernate, but
we can turn the logging system to <code>FINE</code> level
(<code>&lt;property name=“eclipselink.logging.level” value=“FINE”/&gt;</code>), the
interpret SQL would be dumped.</p>

<h1>CRUD</h1>

<p><strong>C</strong>reate, <strong>R</strong>ead, <strong>U</strong>pdate, <strong>D</strong>elete operations in JPA</p>

<p>Read類型的methods像find(), getReference(), refresh(), detach() and read
queries，可以在transaction外執行(沒有tx.begin()/tx.commit()的包覆).</p>

<h4>Create</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>entityManager.getTransaction().begin();
</span><span class='line'>Employee newEmployee = new Employee(5);
</span><span class='line'>entityManager.persist(newEmployee);
</span><span class='line'>entityManager.getTransaction().commit();</span></code></pre></td></tr></table></div></figure>


<h4>Read</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>entityManager.find(Employee.class, 1);
</span><span class='line'>// lazy load (as same as hibernate load() method)
</span><span class='line'>entityManager.getReference(Employee.class, 1);
</span><span class='line'>entityManager.createQuery("select employee from Employee employee");</span></code></pre></td></tr></table></div></figure>


<ul>
<li>for single result uses <code>query.getSingleResult()</code>;</li>
<li>for multiple results (result set) uses <code>query.getResultList()</code>;</li>
</ul>


<h4>Update</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>entityManager.getTransaction().begin();
</span><span class='line'>Employee existingEmployee = entityManager.find(Employee.class, 5);
</span><span class='line'>existingEmployee.setLastName("NewLastName");
</span><span class='line'>entityManager.getTransaction().commit();</span></code></pre></td></tr></table></div></figure>


<p>or</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Employee existingEmployee = entityManager.find(Employee.class, 5);
</span><span class='line'>existingEmployee.setLastName("NewLastName");
</span><span class='line'> 
</span><span class='line'>entityManager.getTransaction().begin();
</span><span class='line'>entityManager.getTransaction().commit();</span></code></pre></td></tr></table></div></figure>


<h4>Delete</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>entityManager.getTransaction().begin();
</span><span class='line'>Employee existingEmployee = entityManager.find(Employee.class, 5);
</span><span class='line'>entityManager.remove(existingEmployee);
</span><span class='line'>entityManager.getTransaction().commit();</span></code></pre></td></tr></table></div></figure>


<h3>Bulk Update / Delete</h3>

<h4>Bulk Update</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>EntityManager entityManager = entityManagerFactory.createEntityManager();
</span><span class='line'>entityManager.getTransaction().begin();
</span><span class='line'>String jpqlUpdate = "update Customer set name = :newName where name = :oldName"
</span><span class='line'>int updatedEntities = entityManager.createQuery( jpqlUpdate )
</span><span class='line'>                            .setParameter( "newName", newName )
</span><span class='line'>                            .setParameter( "oldName", oldName )
</span><span class='line'>                            .executeUpdate();
</span><span class='line'>entityManager.getTransaction().commit();
</span><span class='line'>entityManager.close();</span></code></pre></td></tr></table></div></figure>


<h4>Bulk Delete</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>EntityManager entityManager = entityManagerFactory.createEntityManager();
</span><span class='line'>entityManager.getTransaction().begin();
</span><span class='line'>String hqlDelete = "delete Customer where name = :oldName";
</span><span class='line'>int deletedEntities = entityManager.createQuery( hqlDelete )
</span><span class='line'>                            .setParameter( "oldName", oldName )
</span><span class='line'>                            .executeUpdate();
</span><span class='line'>entityManager.getTransaction().commit();
</span><span class='line'>entityManager.close();</span></code></pre></td></tr></table></div></figure>


<h1>Tips</h1>

<ul>
<li>Using wrapper type rather than primitive type to avoid <a href="http://stackoverflow.com/questions/2565352/whats-difference-between-primitive-and-wrapper-class-in-jpa-hibernate-column-m" title="http://stackoverflow.com/questions/2565352/whats-difference-between-primitive-and-wrapper-class-in-jpa-hibernate-column-m">null
assinged
issue</a>.</li>
</ul>


<h1>FK constraint violation</h1>

<p>Sometime the forgine key constraint that export by DDL tools would be a
problem when doing unit testing. But there is no way to disable
hibernate FK constraints exports. In the situation we can rewrite the
Dialect to prevent FK constraints exported.</p>

<p>In this case, we created our own H2Dialet (for <a href="http://www.h2database.com/html/main.html" title="http://www.h2database.com/html/main.html">H2
database</a>)
and let <code>getAddForeignKeyConstraintString()</code> method empty. Which will
disable the original <code>org.hibernate.dialect.H2Dialect</code> constraint
generating statement.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package com.kent.hibernate.dialect;
</span><span class='line'>
</span><span class='line'>public class H2Dialect extends org.hibernate.dialect.H2Dialect {
</span><span class='line'>    @Override
</span><span class='line'>    public String getAddForeignKeyConstraintString(String constraintName, String[] foreignKey, String referencedTable, String[] primaryKey, boolean referencesPrimaryKey) {
</span><span class='line'>        return "";
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Once we have the Dialect, we need apply it our persistence.xml, after
done, when the schema be generated, the schema will not include any FK
constraint.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
</span><span class='line'>&lt;persistence version="1.0" xmlns="http://java.sun.com/xml/ns/persistence" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_1_0.xsd"&gt;
</span><span class='line'>    &lt;persistence-unit name="entity-test" transaction-type="RESOURCE_LOCAL"&gt;
</span><span class='line'>        &lt;provider&gt;org.hibernate.ejb.HibernatePersistence&lt;/provider&gt;
</span><span class='line'>                 ...
</span><span class='line'>        &lt;properties&gt;
</span><span class='line'>            ...
</span><span class='line'>            &lt;property name="hibernate.hbm2ddl.auto" value="create-drop" /&gt;
</span><span class='line'>                        &lt;property name="hibernate.dialect" value="com.kent.hibernate.dialect.H2Dialect"/&gt;
</span><span class='line'>            ...
</span><span class='line'>        &lt;/properties&gt;
</span><span class='line'>    &lt;/persistence-unit&gt;
</span><span class='line'>&lt;/persistence&gt;</span></code></pre></td></tr></table></div></figure>


<h1>JPA Query</h1>

<p>JPA Query supports</p>

<ol>
<li>query</li>
<li><strong>update</strong></li>
<li><strong>delete</strong></li>
</ol>


<p>function to retrieves, modify, remove data from database.</p>

<h5>IS [NOT] EMPTY</h5>

<p>JPA provides a <strong>empty</strong> to test a collection empty or not:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>select book from Book book where book.chapters is not empty</span></code></pre></td></tr></table></div></figure>


<h5>Join Fetch</h5>

<p>JPA tries to fetch any entity as LAZY as possible whatever uses JPA QL
or get by API.</p>

<p>Fetch lazy or eager is by JPA vendor implementation, not all field type
can fetch as LAZY</p>

<h3>Local Manager Transaction</h3>

<p>In a non-managed environment, an EntityManagerFactory is usually
responsible for its own database connection pool. The application
developer has to manually set transaction boundaries, in other words,
begin, commit, or rollback database transactions itself</p>

<p>If using local manager transaction, better to apply this template in
code.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Non-managed environment idiom
</span><span class='line'>EntityManager em = emf.createEntityManager();
</span><span class='line'>EntityTransaction tx = null;
</span><span class='line'>try {
</span><span class='line'>    tx = em.getTransaction();
</span><span class='line'>    tx.begin();
</span><span class='line'>    // do some work
</span><span class='line'>    ...
</span><span class='line'>    tx.commit();
</span><span class='line'>} catch (RuntimeException e) {
</span><span class='line'>    if ( tx != null && tx.isActive() ) tx.rollback();
</span><span class='line'>    throw e; // or display error message
</span><span class='line'>} finally {
</span><span class='line'>    em.close(); // make sure you always close and never outside of guaranteed finally block
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>Joins and Fetches</h3>

<ol>
<li>inner join = join</li>
<li>left out join = left join</li>
<li>fetch = 用一個select把屬性或集合一次取回</li>
<li>fetch all = 如果有lazy properties，可用fetch all去init all lazy</li>
</ol>


<h1>Expressions</h1>

<ul>
<li>is empty, is not empty</li>
<li>member of, not member of 僅適用於embedded object</li>
<li>elements 測試某個element是否在elements中</li>
<li>minimum, maximum, minindex, maxindex 可用於 array, list, map</li>
<li>KEY() and VALUE() 可用於map</li>
<li>any, some, all, exists, in 這幾個可以和elements,minimum, maximum,
minindex, maxinde 搭配使用</li>
<li>current_date(), current_time(), current_timestamp()</li>
<li>second(…), minute(…), hour(…), day(…), month(…), year(…), (specific
to HQL)</li>
<li>coalesce() and nullif() coalesce（） 取回第一個非NULL的值</li>
<li>TYPE … in …</li>
<li>cast(… as …)</li>
<li>Java public static final constants eg.Color.TABBY</li>
</ul>


<h5>member of</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>'867-5309' MEMBER OF p.phoneNumbers</span></code></pre></td></tr></table></div></figure>


<h5>coalesce</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>SELECT COALESCE( NULL, 34, 13, 0 )
</span><span class='line'>// return 34</span></code></pre></td></tr></table></div></figure>


<h5>any, some, all, exists, in</h5>

<p><a href="http://twpug.net/docs/postgresql-doc-8.0-zh_TW/functions-subquery.html" title="http://twpug.net/docs/postgresql-doc-8.0-zh_TW/functions-subquery.html">any, some, all, exists,
in</a>在SQL-92中的定義</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>select mother from Cat as mother, Cat as kit
</span><span class='line'>where kit in elements(foo.kittens)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>select p from NameList list, Person p where p.name = some elements(list.names)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>select cat from Cat cat where exists elements(cat.kittens)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>select cat from Player p where 3 &gt; all elements(p.scores)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>select cat from Show show where 'fizard' in indices(show.acts)</span></code></pre></td></tr></table></div></figure>


<h5>index</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>select order from Order order where order.items[0].id = 1234</span></code></pre></td></tr></table></div></figure>


<h5>KEY(),VALUE()</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>select i.name, VALUE(p) FROM Item i JOIN i.photos p WHERE KEY(p) LIKE ‘%egret’</span></code></pre></td></tr></table></div></figure>


<p>Data in collection</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public List&lt;Role&gt; listRolesByPermissions(Set&lt;String&gt; permissions) {
</span><span class='line'>  String ql = "select role from Role role left join role.permissions p where p in (:perms)";
</span><span class='line'>  Query q = entityManager.createQuery(ql).setParameter("perms", permissions);
</span><span class='line'>  return q.getResultList();
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>上面的例子採用naming parameter可以正常動作，但下面採用position
parameter的方式卻不行？</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public List&lt;Role&gt; listRolesByPermissions(Set&lt;String&gt; permissions) {
</span><span class='line'>  String ql = "select role from Role role left join role.permissions p where p in (?)";
</span><span class='line'>  Query q = entityManager.createQuery(ql).setParameter(1, permissions);
</span><span class='line'>  return q.getResultList();
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h1>Implementation Restrictions</h1>

<p>To avoid conflicts with the original database operation that fires the
entity lifecycle event (which is still in progress) callback methods
should not call <code>EntityManager</code> or <code>Query</code> methods and should not access
other entity objects.</p>

<p>If a callback method throws an exception within an active transaction,
the transaction is marked for rollback and no more callback methods are
invoked for that operation.</p>

<h1>Architecture</h1>

<h4>EntityManagerFactory</h4>

<p>建立時會比較耗時耗資源，所以應隨server啟動而啟動，關閉而關閉.</p>

<h4>EntityManager</h4>

<p>The EntityManager API is used to access a database in a particular unit
of work. 正常來說，EntityManager的life cycle應該是一個database
transaction(也就是說，應隨著transaction committed而close),
但也可以跨多個database
transactions(跟hibernate的session一樣，可以跟多個transaction).
如果發生任何例外的話，應該要立即呼叫<code>EntityManager.close()</code>，並且棄用EntityManager
instance.</p>

<h1>Annotations</h1>

<p>如果需要讓boolean有預設值，可透過<code>@Column</code>的<code>columnDefinition</code>屬性</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@Column(columnDefinition = "bool default false")
</span><span class='line'>private boolean   boolField;</span></code></pre></td></tr></table></div></figure>


<p>如果要讓欄位接受null，要宣告成物件型別(Object
type)而非原生型別(primitive type)</p>

<h1>Resources</h1>

<ul>
<li><a href="http://wiki.eclipse.org/Using_EclipseLink_JPA_Extensions_%28ELUG%29" title="http://wiki.eclipse.org/Using_EclipseLink_JPA_Extensions_%28ELUG%29">EclipseLink
properties</a></li>
<li><a href="http://docs.jboss.org/hibernate/stable/annotations/reference/en/html_single/" title="http://docs.jboss.org/hibernate/stable/annotations/reference/en/html_single/">hibernate annotations reference
manual</a></li>
<li><a href="http://docs.jboss.org/hibernate/stable/entitymanager/reference/en/html/index.html" title="http://docs.jboss.org/hibernate/stable/entitymanager/reference/en/html/index.html">hibernate Entity Manager reference
manual</a></li>
<li><a href="http://en.wikibooks.org/wiki/Java_Persistence" title="http://en.wikibooks.org/wiki/Java_Persistence">JPA 2 on
wikibook</a></li>
<li><a href="http://wiki.kent-chiu.com/lib/exe/fetch.php?media=java:jpa_mapping.pdf" title="java:jpa_mapping.pdf">A JavaTM Persistence API Mapping Magical Mystery
Tour</a>

<ul>
<li>相當清晰的MAPPING介紹</li>
</ul>
</li>
<li><a href="http://uaihebert.com/?p=1274" title="http://uaihebert.com/?p=1274">JPA Queries and
Tips</a> -
JPA的使用實例，有不到best practices的使用</li>
</ul>


<p>[java</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/02/scala_101/">Scala 101</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-02T00:00:00+08:00" pubdate data-updated="true">Jul 2<span>nd</span>, 2012</time>
        
         | <a href="/blog/2012/07/02/scala_101/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Scala IDE</p>

<ol>
<li>eclipse 3.7 (indigo)</li>
<li>scala IDE plugin 2.9</li>
<li>jdk 1.7.03</li>
</ol>


<p>一切換到scala的環境，IDE就凍住了，用<a href="http://wiki.kent-chiu.com/doku.php?id=java:jvm_profile" title="java:jvm_profile">VirtualVM</a>觀查的結果是執行scala的vm(不是ide本身的vm)的Permanent
Generation
Memory爆了，把它開到256M(-XX:MaxPermSize=256m)就不會一切到scala
perspective，IDE就掛掉。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#utf8 (do not remove)
</span><span class='line'>-startup
</span><span class='line'>../../Common/plugins/org.eclipse.equinox.launcher_1.2.0.v20110502.jar
</span><span class='line'>--launcher.library
</span><span class='line'>../../Common/plugins/org.eclipse.equinox.launcher.i18n.win32.win32.x86_64_4.2.0.v201201111650
</span><span class='line'>-showsplash
</span><span class='line'>C:\Genuitec\Common\plugins\org.eclipse.platform_3.7.2.v201202080800\splash.bmp
</span><span class='line'>--launcher.XXMaxPermSize
</span><span class='line'>256m
</span><span class='line'>--launcher.defaultAction
</span><span class='line'>openFile
</span><span class='line'>-install
</span><span class='line'>C:\Genuitec\Profiles\scala
</span><span class='line'>-configuration
</span><span class='line'>C:\Genuitec\Profiles\scala\configuration
</span><span class='line'>-vmargs
</span><span class='line'>-Xms256m
</span><span class='line'>-Xmx1024m
</span><span class='line'>-XX:MaxPermSize=256m</span></code></pre></td></tr></table></div></figure>


<ul>
<li>scala是可自我成長的語言</li>
<li>scala混合了oo跟function lang</li>
<li>java中的static method可以考慮用function的方式實現，statistic
method可視為一種退化的function lang?</li>
<li>scala是純oo
lang，所有的東西都是物件，所有的操作(含運算子)都是method，所以，可以做運算子的override</li>
<li><p>scala可以與java無縫的整合，事實上，scala很多型號都是來自java。scala
call java lib會很容易，但java call
scala會有比較多的限制，因為scala的物件模型及語意比java豐富，java沒辦法一一對應。</p></li>
<li><p>scala有兩種變數</p></li>
<li><p>expression後面的分號(;)可有可無</p></li>
<li>val : 像java的final變數，一旦宣告後，就不能改變
(如果重新指派，會出reassignment的error)</li>
<li><p>var : 像java的non final變數，可以重新指派值</p></li>
<li><p>scala的array跟java一樣是0-base但是，是透過()存取，而不是[]</p></li>
</ul>


<h5>method</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def mymethod(x: Int, y: Int) : Int = {
</span><span class='line'>  x + y
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def mymethod(x: Int, y: Int) = x + y</span></code></pre></td></tr></table></div></figure>


<p>所有的運算子在scala都是method，所以<code>1 + 2</code>是這樣的method call</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(1).+(2)</span></code></pre></td></tr></table></div></figure>


<p><code>1</code>是物件,<code>+</code>是method name，<code>1</code>物件透過<code>.</code>來呼叫<code>+</code>method並傳入參數值<code>2</code></p>

<p>以這樣的角度來看Array，Array就很直覺了，Array在Scala也只是一般的物件，而不是像java一樣，而不是像java一樣，是屬於語法等級的物件</p>

<h5>foreach</h5>

<p>for (arg ← args) println(arg)</p>

<h3>function</h3>

<h4>function literal</h4>

<p>單行</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(x: Int, y: Int) =&gt; x + y </span></code></pre></td></tr></table></div></figure>


<p>多行時可以用大括號將 functio body括起來</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(x: Int, y: Int) =&gt; {
</span><span class='line'>    val z = x + 1
</span><span class='line'>    z + y
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>這邊用function literal來達到foreach的功能，function literal有三種用法</p>

<p>第一種是最囉嗦,array的item要給型別而且給了型別，外面還要配一對括號</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>myarray.foreach((item: String) =&gt; println(item))</span></code></pre></td></tr></table></div></figure>


<p>這個是比較正常的用法</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>myarray.foreach(item =&gt; println(item))</span></code></pre></td></tr></table></div></figure>


<p>超精簡的用法，但只適用於只有一個參數的狀況</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>myarray.foreach(println)</span></code></pre></td></tr></table></div></figure>


<h5>function return type</h5>

<p>為什麼sum function可以不用指定return type，而factorial必須指定return
type為Int?</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  def sum(a:Int,b:Int) = a+b
</span><span class='line'>  def factorial(n:Int):Int = if (n==0) 1 else n * factorial(n-1)</span></code></pre></td></tr></table></div></figure>


<p>因為在sum function中complier可以推斷(infer)出a +
b的回傳值是Int型別，但在factorial中，回傳值可能是 1
或者是<code>n * factorial(n-1)</code>，
而<code>n * factorial(n-1)</code>是未知型別，所以，我們必須指定return
type，給complier一個提示。</p>

<p>有些語言的compiler可以由factorial function的第一個回傳值為1來推斷return
type為Int，但scala的complier不行</p>

<h5>operator notation</h5>

<ol>
<li>infix 1 + 2</li>
<li>prefix +1,-1, !foo, \~bar (只有+,-,!,\~可以為prefix
operator,定為方式為<code>unary_+</code>,<code>unary_-</code>,<code>unary_!</code>,<code>unary_~</code>,)</li>
<li>postfix 1.toLong</li>
</ol>


<h4>functionN</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package scala
</span><span class='line'> 
</span><span class='line'> 
</span><span class='line'>trait Function2[@specialized(scala.Int, scala.Long, scala.Double) -T1, @specialized(scala.Int, scala.Long, scala.Double) -T2, @specialized(scala.Unit, scala.Boolean, scala.Int, scala.Float, scala.Long, scala.Double) +R] extends AnyRef { self =&gt;
</span><span class='line'>  /** Apply the body of this function to the arguments.
</span><span class='line'>   *  @return   the result of function application.
</span><span class='line'>   */
</span><span class='line'>  def apply(v1: T1, v2: T2): R
</span><span class='line'> 
</span><span class='line'>  /** Creates a curried version of this function.
</span><span class='line'>   *
</span><span class='line'>   *  @return   a function `f` such that `f(x1)(x2) == apply(x1, x2)`
</span><span class='line'>   */
</span><span class='line'>  def curried: T1 =&gt; T2 =&gt; R = {
</span><span class='line'>    (x1: T1) =&gt; (x2: T2) =&gt; apply(x1, x2)
</span><span class='line'>  }
</span><span class='line'>  @deprecated("Use 'curried' instead", "2.8.0")
</span><span class='line'>  def curry = curried
</span><span class='line'> 
</span><span class='line'>  /** Creates a tupled version of this function: instead of 2 arguments,
</span><span class='line'>   *  it accepts a single [[scala.Tuple2]] argument.
</span><span class='line'>   *
</span><span class='line'>   *  @return   a function `f` such that `f((x1, x2)) == f(Tuple2(x1, x2)) == apply(x1, x2)`
</span><span class='line'>   */
</span><span class='line'>  def tupled: Tuple2[T1, T2] =&gt; R = {
</span><span class='line'>    case Tuple2(x1, x2) =&gt; apply(x1, x2)
</span><span class='line'>  }
</span><span class='line'>  override def toString() = "&lt;function2&gt;"
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>scala中的每個function，都是實作像上面的functionN(N從0\~22)的trait，以<code>(x: Int, y: Int) ⇒ x + y</code>來說，就是上例中的Function2[-T1,
-T2, +R]， 因為 (x: Int, y: Int) ⇒ x + y 就
傳入兩個int的參數並傳回一個int的結果，這樣與Function2的<code>def apply(v1: T1, v2: T2): R</code>是相等的。</p>

<h4>closure</h4>

<p>closure跟function literal語法很相似，但closure多了<a href="#free_variables" title="scala:scala_101 ↵">free
variables</a>，所以，free
variables可被當做區分closure跟function literal的依據</p>

<h5>free variables</h5>

<p>TBC</p>

<h4>Constructor</h4>

<h5>primary constructor</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class MyClass(x: Int, y: Int)</span></code></pre></td></tr></table></div></figure>


<h5>auxiliary constructor</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class MyClass(x: Int) {
</span><span class='line'>    def this(x:Int) = this(x, 1) 
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>在scala，只有primary constructor可以呼叫super class的Constructor</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> </span></code></pre></td></tr></table></div></figure>


<h4>function parameters</h4>

<h5>repeated parameters</h5>

<p>repeated parameters像java的 myfunc(String…
args)，後面能用0到多個相同型別的參數</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def myfunc(args: String*)</span></code></pre></td></tr></table></div></figure>


<h5>naming parameters</h5>

<p>naming
parameters主要是在使用functions時可以指定參數的名稱，也因為可以指定參數的名稱，
所以傳入的參數順序可以跟原來宣告時的不一樣</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def myfunc(foo: Int, bar: String)
</span><span class='line'> 
</span><span class='line'>// call myfunc with naming parameter
</span><span class='line'>val x = myfunc(bar="test", foo=1)</span></code></pre></td></tr></table></div></figure>


<h5>default value</h5>

<p>參數的預設值，如果沒有特別指定時，參數會以預設值為準</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def myfunc(foo: Int = 5)</span></code></pre></td></tr></table></div></figure>


<h5>loop</h5>

<p>如while 或者是 do-while loop 都是會帶有副作用(side
effect)，請儘量改用其他的方式實作</p>

<h5>for</h5>

<p>for loop有filter的功能</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>val filesHere = (new java.io.File(".")).listFiles
</span><span class='line'>for (file &lt;- filesHere if file.getName.endsWith(".scala"))
</span><span class='line'>  println(file)
</span><span class='line'> 
</span><span class='line'>// 上面那邊，的效果等同於  
</span><span class='line'>for (file &lt;- filesHere)
</span><span class='line'>  if (file.getName.endsWith(".scala"))
</span><span class='line'>    println(file)  </span></code></pre></td></tr></table></div></figure>


<p>filter也可以累加，像這樣</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>for (
</span><span class='line'>  file &lt;- filesHere
</span><span class='line'>  if file.isFile
</span><span class='line'>  if file.getName.endsWith(".scala")
</span><span class='line'>) println(file)</span></code></pre></td></tr></table></div></figure>


<h5>apply() and update()</h5>

<p><code>()</code>跟<code>()=</code>是語法糖(complier sugar)，分別等效於<code>apply()</code>跟<code>update()</code> ()
: apply() ()= : update()</p>

<h3>Import and Package</h3>

<h5>pacakge</h5>

<ol>
<li>可以是 java style ，把 package name 放在最上面</li>
<li>可以是 c# like，用 com.kentchiu { <em>package content } 或 com{
kentchiu {</em> package content} }</li>
<li>_root_ package</li>
</ol>


<h5>import</h5>

<p>與 java 的不同</p>

<ol>
<li>可以直接 import class member</li>
<li>可以 rename 或隱藏部份被 import 的 members</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import com.kentchiu.{Foo, Bar}        // 只 import Foo 跟 Bar
</span><span class='line'>import com.kentchiu.{Foo, Bar =&gt; Baz} // 只 import Foo 跟 Bar， Bar 改名為 Baz
</span><span class='line'>import com.kentchiu.{Bar =&gt; _, _}     // Bar rename 成 _ ，會變成 import com.kentchiu 但把 Bar 排外</span></code></pre></td></tr></table></div></figure>


<h3>trait</h3>

<p>Trait像是java的interface，不過，更像是ruby的mixin</p>

<h5>Ordered Trait</h5>

<p>Ordered Trait是用來說明trait一個很好的例子，Rubyer應該對這個例子很眼熟</p>

<h3>case class</h3>

<h5>function programming</h5>

<p>Functional programming is a programming paradigm that describes
computation as the evaluation of mathematical functions avoiding state,
mutual data and therefore side effects</p>

<p>Function programming based on applying functions to arguments in order
to receive some desired values</p>

<p>The core idea for computation has shifted from a series of instructions
(which specify precisely how the computation should proceed) to Notation
of expressions, based on functions and values. You no longer have to
follow a plan of instructions in order to understand a computation but
decompose such an expression into its single elements.</p>

<h3>Sequence Comprehensions</h3>

<h3>Tuple</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>scala&gt; val t = (1,2)
</span><span class='line'>t: (Int, Int) = (1,2)
</span><span class='line'> 
</span><span class='line'>scala&gt; val t = new Tuple2(1,2)
</span><span class='line'>t: (Int, Int) = (1,2)</span></code></pre></td></tr></table></div></figure>


<p>tuple是透過特殊index語法存取</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>scala&gt; t._1
</span><span class='line'>res3: Int = 1
</span><span class='line'> 
</span><span class='line'>scala&gt; t._2
</span><span class='line'>res4: Int = 2</span></code></pre></td></tr></table></div></figure>


<p>另外一種建立tuple的語法</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>scala&gt; 1-&gt;2
</span><span class='line'>res0: (Int, Int) = (1,2)</span></code></pre></td></tr></table></div></figure>


<h3>Extractors</h3>

<p>利用 <code>unApply()</code> method搭配pattern match將資訊從class中萃取出來</p>

<h3>Parser Combinators</h3>

<ul>
<li>Christoph Henkelmann’s Blog - An Introduction To Scala Parser
Combinators

<ol>
<li><a href="http://henkelmann.eu/2011/01/13/an_introduction_to_scala_parser_combinators" title="http://henkelmann.eu/2011/01/13/an_introduction_to_scala_parser_combinators">Part 1: Parser
Basics</a></li>
<li><a href="http://henkelmann.eu/2011/01/28/an_introduction_to_scala_parser_combinators-part_2_literal_expressions" title="http://henkelmann.eu/2011/01/28/an_introduction_to_scala_parser_combinators-part_2_literal_expressions">Part 2: Parsing Literal
Expressions</a></li>
<li><a href="http://henkelmann.eu/2011/01/29/an_introduction_to_scala_parser_combinators-part_3_unit_tests" title="http://henkelmann.eu/2011/01/29/an_introduction_to_scala_parser_combinators-part_3_unit_tests">An Introduction To Scala Parser Combinators - Part 3: Writing
unit tests for
parsers</a></li>
</ol>
</li>
</ul>


<h3>Symbol Literals</h3>

<p>Symbol Literals是在字串前加一個單引號&#8217;，像這樣&#8217;foo</p>

<p>Symbol
Literal主要作用是用來當作識別用，可以視為一個字串，但它不同於字串的地方有</p>

<ol>
<li>不可以有任何空白</li>
<li>一致性</li>
<li>對重構比較友善</li>
</ol>


<p>像典型的map可以寫成這樣</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"key" -&gt; "value"</span></code></pre></td></tr></table></div></figure>


<p>key的部份可以換成Symbol Literal取代</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>'key -&gt; "value"</span></code></pre></td></tr></table></div></figure>


<p>這樣的好處是，&#8217;key更能代表唯一性，而且，如果要進行重構，&#8217;key對於重構的支援會比”key”來的好，如果任何地方需要用字串當作識別的時侯，或者可以考慮換成用Symbol
Literal取代</p>

<h1>TBD</h1>

<ul>
<li>The Divide and Conquer principle</li>
<li>Implicit Conversions and Parameters</li>
</ul>


<h1>Resource</h1>

<ul>
<li><a href="http://www.scala-lang.org/" title="http://www.scala-lang.org/">http://www.scala-lang.org/</a>
官網</li>
<li><a href="http://docs.scala-lang.org/index.html" title="http://docs.scala-lang.org/index.html">http://docs.scala-lang.org/index.html</a>
官網文件</li>
<li>Functional scala serial
這一系列教學，很適合java背景，而且沒有function programming的人

<ol>
<li><a href="http://gleichmann.wordpress.com/2010/10/28/functional-scala-introduction/" title="http://gleichmann.wordpress.com/2010/10/28/functional-scala-introduction/">episode 1:
Introduction</a></li>
<li><a href="http://gleichmann.wordpress.com/2010/10/31/functional-scala-functions/" title="http://gleichmann.wordpress.com/2010/10/31/functional-scala-functions/">episode 2:
Functions</a></li>
<li><a href="http://gleichmann.wordpress.com/2010/11/08/functional-scala-functions-as-objects-as-functions/" title="http://gleichmann.wordpress.com/2010/11/08/functional-scala-functions-as-objects-as-functions/">episode 3: Functions as Objects as
Functions</a></li>
<li><a href="http://gleichmann.wordpress.com/2010/11/15/functional-scala-closures/" title="http://gleichmann.wordpress.com/2010/11/15/functional-scala-closures/">episode 4:
Closures</a></li>
<li><a href="http://gleichmann.wordpress.com/2010/11/21/functional-scala-comprehending-comprehensions/" title="http://gleichmann.wordpress.com/2010/11/21/functional-scala-comprehending-comprehensions/">episode 5: Comprehending
Comprehensions</a></li>
<li><a href="http://gleichmann.wordpress.com/2010/11/28/high-higher-higher-order-functions/" title="http://gleichmann.wordpress.com/2010/11/28/high-higher-higher-order-functions/">episode 6: High, Higher, Higher Order
Functions</a></li>
<li><a href="http://gleichmann.wordpress.com/2010/12/05/functional-scala-lambdas-and-other-shortcuts/" title="http://gleichmann.wordpress.com/2010/12/05/functional-scala-lambdas-and-other-shortcuts/">episode 7: Lambdas and other
shortcuts</a></li>
</ol>
</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/02/play_framework_101/">Play Framework 101</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-02T00:00:00+08:00" pubdate data-updated="true">Jul 2<span>nd</span>, 2012</time>
        
         | <a href="/blog/2012/07/02/play_framework_101/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>在eclipse直接執行play console</h3>

<h3>Http Request處理流程</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>browser : http://localhost/foo?bar=baz
</span><span class='line'>
</span><span class='line'># project_home/conf/routes
</span><span class='line'>GET    /foo                        controllers.Application.foo(bar: String)
</span><span class='line'>
</span><span class='line'># project_home/app/controllers/Application.scala
</span><span class='line'>object Application extends Controller {
</span><span class='line'>
</span><span class='line'>    def foo(bar: String) = Action {
</span><span class='line'>        Ok("bar param value is: " +  bar) // 網頁顯示 bar param value is: baz
</span><span class='line'>    }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>由網頁發起url: http://localhost/foo?bar=baz</li>
<li>play收到url後，會由routes這個設定檔來決定負責處理的controller是誰</li>
<li>controller中會有一個跟url
path相符的method進行處理，然後回應一個Action</li>
</ol>


<p>主要的流程就這樣，相當的單純</p>

<h3>Controller</h3>

<p>Controller是一個Singlton
Object，用來產生Action</p>

<h3>Action</h3>

<p>在play.api.mvc裡有兩個Action，一個是Singlton Object,另一個是trait，
trait的這個Action是一個 <code>play.api.mvc.Request ⇒ play.api.mvc.Result</code>
function負責處理並回應http request， 而Singtlton
Object這個Action是companion object，提供建立Action的一些helper
methods</p>

<p>Ok()這個method會回http status code 200給browser，http status code
200，就是沒有任何錯誤</p>

<p><img src="http://blog.kent-chiu.com/images/2012-07-02/play_framework_101-001.png" alt="play_framework_101-001.png" /></p>

<p>上面有提到Action是<code>play.api.mvc.Request ⇒ play.api.mvc.Result</code>
function，而AsyncResult, ChunkedResult, PlainResult, SimpleResult,
Status都是extends自trait Result，所以可以當作Action的傳回值</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package controllers
</span><span class='line'> 
</span><span class='line'>import play.api._
</span><span class='line'>import play.api.mvc._
</span><span class='line'> 
</span><span class='line'>object Application extends Controller {
</span><span class='line'> 
</span><span class='line'>  def index = Action {
</span><span class='line'>    Ok(views.html.index("Your new application is ready."))
</span><span class='line'>  }
</span><span class='line'> 
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Ok(context) 表示回應http 200(正常)給網頁，content是要顯示的內容</p>

<p>ex:</p>

<p><code>Ok("Hello World")</code></p>

<p>網頁就會顯示 Hello World</p>

<p><code>views.html.index("Your new application is ready.")</code></p>

<p>則是套用play的template來顯示內容</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def index(param: String) = Action { implicit request =&gt;
</span><span class='line'>  Ok("Got request [" + request + "] with param [" + param +"]")
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>Request and Session</h3>

<p>Play的Session可以透過request.session取得，它是用cookie實作的，而且沒有所謂的session
timeout，如果需要session timeout的功能，要自已實作。</p>

<p>Play的Request不像java那樣，可以直接當作資料的載體，需透過Flash
Scope(也就是java servlet的request scope)</p>

<h2>Scala Template Engine</h2>

<h4>Handling the form submission</h4>

<p>在todolist這個教學中，有一段code是在建立 new
task的，這一些，對非scala的熟手來說不是那麼的易懂</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Application
</span><span class='line'>def newTask = Action { implicit request =&gt;
</span><span class='line'>  taskForm.bindFromRequest.fold(
</span><span class='line'>    errors =&gt; BadRequest(views.html.index(Task.all(), errors)),
</span><span class='line'>    label =&gt; {
</span><span class='line'>      Task.create(label)
</span><span class='line'>      Redirect(routes.Application.tasks)
</span><span class='line'>    }
</span><span class='line'>  )
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>newTask這個method的傳回值是Action型別,
taskForm一是個<code>play.api.data.Form</code>型別，而<code>bindFromRequest</code>跟<code>fold</code>的API如下:
taskForm.bindFromRequest的回傳值是Form[String]，而newTask的型別是Action，所以taskForm.bindFromRequest的結果不能直接當newAction的結果。
fold的回傳值是R，我們只要讓R為Action型別即可當newTask的回傳值。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> * Binds request data to this form, i.e. handles form submission.
</span><span class='line'> *
</span><span class='line'> * @return a copy of this form filled with the new data
</span><span class='line'> */
</span><span class='line'>def bindFromRequest()(implicit request: play.api.mvc.Request[_]): Form[T] = {
</span><span class='line'>  val data = (request.body match {
</span><span class='line'>    case body: play.api.mvc.AnyContent if body.asFormUrlEncoded.isDefined =&gt; body.asFormUrlEncoded.get
</span><span class='line'>    case body: play.api.mvc.AnyContent if body.asMultipartFormData.isDefined =&gt; body.asMultipartFormData.get.asFormUrlEncoded
</span><span class='line'>    case body: play.api.mvc.AnyContent if body.asJson.isDefined =&gt; FormUtils.fromJson(js = body.asJson.get).mapValues(Seq(_))
</span><span class='line'>    case body: Map[_, _] =&gt; body.asInstanceOf[Map[String, Seq[String]]]
</span><span class='line'>    case body: play.api.mvc.MultipartFormData[_] =&gt; body.asFormUrlEncoded
</span><span class='line'>    case body: play.api.libs.json.JsValue =&gt; FormUtils.fromJson(js = body).mapValues(Seq(_))
</span><span class='line'>    case _ =&gt; Map.empty[String, Seq[String]]
</span><span class='line'>  }) ++ request.queryString
</span><span class='line'>  bind(data.mapValues(_.headOption.getOrElse("")))
</span><span class='line'>}
</span><span class='line'>   
</span><span class='line'>   
</span><span class='line'>def fold[R](hasErrors: Form[T] =&gt; R, success: T =&gt; R): R = value.map(success(_)).getOrElse(hasErrors(this))</span></code></pre></td></tr></table></div></figure>


<p>fold的第一個hasErrors的參數是，在這邊是個像這樣的function literal
Form[String] ⇒ R(也就是你需要傳入適合的function value進去)
因為我們希望fold的結果可以直接當newTask
method的回傳值，所以R的型別為Action，也就是</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def fold[R](hasErrors: Form[T] =&gt; R, success: T =&gt; R): R = value.map(success(_)).getOrElse(hasErrors(this))</span></code></pre></td></tr></table></div></figure>


<p>在這個例子的實際的型別是</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def fold[Action](hasErrors: Form[String] =&gt; Action, success: String =&gt; Action): Action = value.map(success(_)).getOrElse(hasErrors(this))</span></code></pre></td></tr></table></div></figure>


<p>fold的使用範例是這樣</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>    anyForm.bindFromRequest().fold(
</span><span class='line'>       f =&gt; redisplayForm(f),                   // hasErrors: Form[String] =&gt; Action
</span><span class='line'>       t =&gt; handleValidFormSubmission(t)        // success: String =&gt; Action 
</span><span class='line'>    )
</span></code></pre></td></tr></table></div></figure>


<p>裡面的redisplayForm跟handleValidFormSubmission並不是play
API的一部份，他只是一個pseudo
code，用來表示通常hasErrors的處理方式是redisplayForm，而success的處理方式是handleValidFormSubmission</p>

<p>再回來看成來的例子</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Application
</span><span class='line'>def newTask = Action { implicit request =&gt;
</span><span class='line'>  taskForm.bindFromRequest.fold(
</span><span class='line'>    errors =&gt; BadRequest(views.html.index(Task.all(), errors)),  // hasErrors: Form[String] =&gt; Action
</span><span class='line'>    label =&gt; {                                                   // success: String =&gt; Action 
</span><span class='line'>      Task.create(label)
</span><span class='line'>      Redirect(routes.Application.tasks)
</span><span class='line'>    }
</span><span class='line'>  )
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h5>hasErrors參數的部份</h5>

<p>errors是Form[String]，而BadRequest是Action型別</p>

<p>hasErrors時會redisaply form，也就是用BadRequest(status 400)取代Ok(status
200)呼叫views.html.index，並把form的內容傳入</p>

<h5>success參數的部份</h5>

<p>label是String型別,
而傳回值Redirect(routes.Application.tasks)是Action型別 success時會handle
valid form submission，也就是建立task後，然後再轉到task list的頁面</p>

<h1>MISC</h1>

<h3>mapping method in Form</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import play.api.data._
</span><span class='line'>import play.api.data.Forms._
</span><span class='line'> 
</span><span class='line'>case class User(name: String, age: Int)
</span><span class='line'> 
</span><span class='line'>val userForm = Form(
</span><span class='line'>  mapping(
</span><span class='line'>    "name" -&gt; text,
</span><span class='line'>    "age" -&gt; number
</span><span class='line'>  )(User.apply)(User.unapply)
</span><span class='line'>)
</span><span class='line'> 
</span><span class='line'>val anyData = Map("name" -&gt; "bob", "age" -&gt; "18")
</span><span class='line'>val user: User = userForm.bind(anyData).get</span></code></pre></td></tr></table></div></figure>


<p>Form裡面的mapping，對於play的新手，很容易誤為是Form.mapping()，但怎麼看，都對不起來，完全不知道為什麼可以用apply()跟unapply()，其實它是Forms.mapping()</p>

<p>Forms.mapping是長這樣</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> * Creates a Mapping of type `T`.
</span><span class='line'> *
</span><span class='line'> * For example:
</span><span class='line'> *
</span><span class='line'> * @tparam T the mapped type
</span><span class='line'> * @param apply A function able to create a value of T from a value of A1 (If T is case class you can use its own apply function)
</span><span class='line'> * @param unapply A function able to create A1 from a value of T (If T is a case class you can use its own unapply function)
</span><span class='line'> * @return a mapping for type `T`
</span><span class='line'> */
</span><span class='line'>def mapping[R, A1](a1: (String, Mapping[A1]))(apply: Function1[A1, R])(unapply: Function1[R, Option[(A1)]]): Mapping[R] = {
</span><span class='line'>  ObjectMapping1(apply, unapply, a1)
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>對於本來就看不太懂API的新手，還找錯API，只會讓新手更覺得太多無法理解的migic</p>

<h4>細節說明</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mapping[R, A1](a1: (String, Mapping[A1]))(apply: Function1[A1, R])(unapply: Function1[R, Option[(A1)]]): Mapping[R]</span></code></pre></td></tr></table></div></figure>


<p>mapping(…)(…)(…)把參數分成多個”群組”，表示這個function是<em>curried(柯里化)</em></p>

<p>先做大部拆解，這個method可以分為五個部份</p>

<ol>
<li>mapping[R, A1] 名稱，對應到上例中的mapping</li>
<li>(a1: (String, Mapping[A1])) 參數第一組，對應到上例中的 “email” →
of[String]</li>
<li>(apply: Function1[A1, R]) 參數第二組，對應到上例中的 User.apply</li>
<li>(unapply: Function1[R, Option[(A1)]]) 參數第三組，對應到上例中的
User.unapply</li>
<li>Mapping[R] 回傳值</li>
</ol>


<p>apply,unapply是來自case class</p>

<h5>mapping[R, A1]</h5>

<p>這部份可以知道裡面會有兩個泛型，一個是R,一個是A1</p>

<h5>(a1: (String, Mapping[A1]))</h5>

<p><code>(String, Mapping[A1])</code>是一個tuple，本例中為<code>“email” → of[String]</code></p>

<p>Mapping[A1]中的Mapping是trait型別，主要的功能是做格式間的轉換，本例是將request
string透過轉成String,Int,…格式</p>

<h5>(apply: Function1[A1, R])</h5>

<p><code>(apply: Function1[A1, R])</code>是一個function literal,在本例中為<code>User.apply</code>，</p>

<p>作用是將mapping的結果轉成User物件</p>

<p>由API可以知道Mapping是泛型<code>Mapping[R]</code>，所以R在例中，是<code>User</code></p>

<h5>(unapply: Function1[R, Option[(A1)]])</h5>

<p><code>(unapply: Function1[R, Option[(A1)]])</code>是一個function
literal,本例中為<code>User.unapply</code></p>

<p>作用是將User物件解構，把User的值再指派到<code>“email” → of[String]</code></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/06/27/bad_smell/">Code Smell</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-27T00:00:00+08:00" pubdate data-updated="true">Jun 27<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/06/27/bad_smell/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>程式碼的臭味，來自Martin的Refactory一書，用來形容程式碼中邏輯上沒問題，但<strong>感覺</strong>起來怪怪的(或聞起來臭臭的)地方。你必須知道程式那裡在發臭，才有辦法去除臭。</p>

<p>這些文章很重要呀，一定要不斷的讀，甚至每隔幾周、幾月就重複的看一次，因為當你有實作經驗後，讀起來會有更深刻的體驗呀。</p>

<h2>Code Smell Within Classes</h2>

<ol>
<li>Comments</li>
<li>Long Method （過長函式）</li>
<li>Long Parameter List</li>
<li>Duplicated code （重複的程式碼）</li>
<li>Conditional Complexity</li>
<li>Combinitorial Explosion</li>
<li>Large Class</li>
<li>Type Embedded in Name</li>
<li>Uncommunicative Name</li>
<li>Inconsistent Names</li>
<li>Dead Code</li>
<li>Speculative Generality</li>
<li>Oddball Solution</li>
<li>Temporary Field</li>
</ol>


<h2>Code Smells Between Classes</h2>

<ol>
<li>Alternative Classes</li>
<li>Primitive Obsession</li>
<li>Data Class</li>
<li>Data Clumps</li>
<li>Refused Bequest</li>
<li>Inappropriate</li>
<li>Indecent Exposure</li>
<li>Feature Envy</li>
<li>Lazy Class</li>
<li>Message Chains</li>
<li>Middle Man</li>
<li>Divergent Change</li>
<li>Shotgun Surgery</li>
<li>Parallel Inheritance Hierarchies</li>
<li>Incomplete Library Class</li>
<li>Solution Sprawl</li>
</ol>


<h2>Code Smells Category</h2>

<p>以下內容均取自重構一書。</p>

<h3>Duplicated Code（重複的程式碼）</h3>

<p>臭味行列中首當其衝的就是Duplicated
Code。如果你在一個以上的地點看到相同的程式結構，那麼當可肯定：設法將它們合而為一，程式會變得更好。</p>

<p>最單純的Duplicated Code 就是「<strong>同一個class
內的兩個函式含有相同算式（expression）</strong>」。這時候你需要做的就是採用Extract
Method（110）提煉出重複的程式碼，然後讓這兩個地點都呼叫被提煉出來的那一段程式碼。</p>

<p>另一種常見情況就是「<strong>兩個互為兄弟（sibling）的subclasses
內含相同算式</strong>」。要避免這種情況，只需對兩個classes 都使用Extract
Method（110），然後再對被提煉出來的程式碼使用Pull Up
Method（332），將它推入superclass
內。如果程式碼之間只是類似，並非完全相同，那麼就得運用Extract
Method（110）將相似部分和差異部分割開，構成單獨一個函式。然後你可能發現或許可以運用Form
TemplateMethod（345）獲得一個Template Method
設計範式。如果有些函式以不同的演算法做相同的事，你可以擇定其中較清晰的一個，並使用Substitute
Algorithm（139）將其他函式的演算法替換掉。</p>

<p>如果兩個毫<strong>不相關的classes 內出現Duplicated
Code</strong>，你應該考慮對其中一個使用Extract
Class（149），將重複程式碼提煉到一個獨立class中，然後在另一個class內使用這個新class。但是，重複程式碼所在的函式也可能的確只應該屬於某個class，另一個class只能呼叫它，抑或這個函式可能屬於第三個class，而另個classes應該引用這第三個class。你必須決定這個函式放在哪兒最合適，並確保它被安置後就不會再在其他任何地方出現。</p>

<h3>Long Method（過長函式）</h3>

<p>擁有「短函式」（short
methods）的物件會活得比較好、比較長。不熟悉物件導向技術的人，常常覺得物件程式中只有無窮無盡的delegation（委託），根本沒有進行任何計算。和此類程式共同生活數年之後，你才會知道，這些小小函式有多大價值。「間接層」所能帶來的全部利益
— 解釋能力、共享能力、選擇能力 — 都是由小型函式支援的（請看p.61
的「間接層和重構」）。</p>

<p>很久以前程式員就已認識到：程式愈長愈難理解。早期的編程語言中，「子程式叫用動作」需要額外開銷，這使得人們不太樂意使用small
method。現代OO語言幾乎已經完全免除了行程（process）內的「函式叫用動作額外開銷」。不過程式碼閱讀者還是得多費力氣，因為他必須經常轉換上下文去看看子程式做了什麼。某些開發環境允許使用者同時看到兩個函式，這可以幫助你省去部分麻煩，但是讓small
method
容易理解的真正關鍵在於一個好名字。如果你能給函式起個好名字，讀者就可以通過名字了解函式的作用，根本不必去看其中寫了些什麼。</p>

<p>最終的效果是：你應該更積極進取地分解函式。我們遵循這樣一條原則：每<strong>當感覺需要以註釋來說明點什麼的時候</strong>，我們就把需要說明的東西寫進一個獨立函式中，並以其用途（而非實現手法）命名。我們可以對一組或甚至短短一行程式碼做這件事。哪怕替換後的函式呼叫動作比函式本身還長，只要函式名稱能夠解釋其用途，我們也該毫不猶豫地那麼做。關鍵不在於函式的長度，而在於函式「做什麼」和「如何做」之間的語意距離。</p>

<p>百分之九十九的場合裡，要把函式變小，只需使用Extract
Method（110）。找到函式中適合集在一起的部分，將它們提煉出來形成一個新函式。</p>

<p>如果<strong>函式內有大量的參數和暫時變數</strong>，它們會對你的函式提煉形成阻礙。如果你嘗試運用Extract
Method（110），最終就會把許多這些參數和暫時變數當做參數，傳遞給被提煉出來的新函式，導致可讀性幾乎沒有任何提昇。啊是的，你可以經常運用Replace
Temp with Query（120）來消除這些暫時元素。Introduce
ParameterObject（295）和Preserve Whole
Object（288）則可以將過長的參數列變得更簡潔一些。</p>

<p>如果你已經這麼做了，仍然有太多暫時變數和參數，那就應該使出我們的殺手翦：Replace
Method with Method Object（135）。</p>

<p>如何確定該提煉哪一段程式碼呢？一個很好的技巧是：尋找註釋。它們通常是指出「程式碼用途和實現手法間的語意距離」的信號。如果程式碼前方有一行註釋，就是在提醒你：可以將這段程式碼替換成一個函式，而且可以在註釋的基礎上給這個函式命名。就算只有一行程式碼，如果它需要以註釋來說明，那也值得將它提煉到獨立函式去。</p>

<p><strong>條件式和迴圈常常也是提煉的信號</strong>。你可以使用Decompose
Conditional（238）處理條件式。至於迴圈，你應該將迴圈和其內的程式碼提煉到一個獨立函式中。</p>

<h3>Large Class（過大類別）</h3>

<p>如果想利用單一class 做太多事情，其內往往就會<strong>出現太多instance
變數</strong>。一旦如此，Duplicated Code 也就接踵而至了。</p>

<p>你可以運用Extract Class（149）將數個變數一起提煉至新class
內。提煉時應該選擇class 內彼此相關的變數，將它們放在一起。例如
“depositAmount” 和”depositCurrency”
可能應該隸屬同一個class。通常如果class
內的<strong>數個變數有著相同的字首或字尾</strong>，這就意味有機會把它們提煉到某個組件內。如果這個組件適合作為一個subclass，你會發現Extract
Subclass（330）往往比較簡單。有時候class
並非在所有時刻都使用所有instance
變數。果真如此，你或許可以多次使用Extract Class（149）或Extract
Subclass（330）。</p>

<p>和「太多instance 變數」一樣，<strong>class
內如果有太多程式碼</strong>，也是「程式碼重複、混亂、死亡」的絕佳滋生地點。最簡單的解決方案（還記得嗎，我們喜歡簡單的解決方案）是把贅餘的東西消弭於class
內部。如果有五個「百行函式」，它們之中很多程式碼都相同，那麼或許你可以把它們變成五個「十行函式」和十個提煉出來的「雙行函式」。</p>

<p>和「擁有太多instance變數」一樣，一個class
如果擁有太多程式碼，往往也適合使用Extract Class（149）和Extract
Subclass（330）。這裡有個有用技巧：先確定客戶端如何使用它們，然後運用Extract
Interface（341）為每一種使用方式提煉出一個介面。這或許可以幫助你看清楚如何分解這個class。</p>

<p>如果你的Large Class 是個GUI
class，你可能需要把資料和行為移到一個獨立的領域物件（domain
object）去。你可能需要兩邊各保留一些重複資料，並令這些資料同步（sync.）。Duplicate
Observed
Data（189）告訴你該怎麼做。這種情況下，特別是如果你使用舊式Abstract
Windows Toolkit（AWT）組件，你可以採用這種方式去掉GUI class
並代以Swing組件。</p>

<h5>Long Parameter List（過長參數列）</h5>

<p>剛開始學習編程的時候，老師教我們：把函式所需的所有東西都以參數傳遞進去。這可以理解，因為除此之外就只能選擇全域資料，而全域資料是邪惡的東西。物件技術改變了這一情況，因為如果你手上沒有你所需要的東西，總可以叫另一個物件給你。因此，有了物件，你就不必把函式需要的所有東西都以參數傳遞給它了，你只需傳給它足夠的東西、讓函式能從中獲得自己需要的所有東西就行了。<strong>函式需要的東西多半可以在函式的宿主類別（host
class）中找到</strong>。物件導向程式中的函式，其參數列通常比在傳統程式中短得多。</p>

<p>這是好現象，因為太長的參數列難以理解，太多參數會造成前後不一致、不易使用，而且一旦你需要更多資料，就不得不修改它。如果將物件傳遞給函式，大多數修改都將沒有必要，因為你很可能只需（在函式內）增加一兩條請求（requests），就能得到更多資料。</p>

<p>如果「向既有物件發出一條請求」就可以取得原本位於參數列上的一份資料，那麼你應該啟動重構準則Replace
Parameter with Method（292）。上述的既有物件可能是函式所屬class
內的一個資料欄（field），也可能是另一個參數。你還可以運用Preserve Whole
Object（288）將來自同一物件的一堆資料收集起來，並以該物件替換它們。如果某些資料缺乏合理的物件歸屬，可使用Introduce
ParameterObject（295）為它們製造出一個「參數物件」。</p>

<p>此間存在一個重要的例外。有時候你明顯不希望造成「被叫用之物件」與「較大物件」間的某種依存關係。這時候將資料從物件中拆解出來單獨作為參數，也很合情合理。但是請注意其所引發的代價。如果參數列太長或變化太頻繁，你就需要重新考慮自己的依存結構（dependency
structure）了。</p>

<h3>Divergent Change（發散式變化）</h3>

<p>我們希望軟體能夠更容易被修改 —
畢竟軟體再怎麼說本來就該是「軟」的。一旦需要修改，我們希望能夠跳到系統的某一點，只在該處作修改。如果不能做到這點，你就嗅出兩種緊密相關的刺鼻味道中的一種了。</p>

<p>如果某個class經常因為不同的原因在不同的方向上發生變化，Divergent
Change就出現了。當你看著一個class
說：『呃，如果新加入一個資料庫，我必須修改這三個函式；如果新出現一種金融工具，我必須修改這四個函式』，那麼此時也許將這個物件分成兩個會更好，這麼一來每個物件就可以只因一種變化而需要修改。</p>

<p>當然，往往只有在加入新資料庫或新金融工具後，你才能發現這一點。針對某一<strong>外界變化的所有相應修改，都只應該發生在單一class
中</strong>，而這個新class
內的所有內容都應該反應該外界變化。為此，你應該找出因著某特定原因而造成的所有變化，然後運用Extract
Class（149）將它們提煉到另一個class 中。</p>

<h3>Shotgun Surgery（霰彈式修改）</h3>

<p><strong>Shotgun Surgery類似Divergent
Change，但恰恰相反</strong>。如果每遇到某種變化， 你都必須在許多不同的classes
內作出許多小修改以回應之，你所面臨的壞味道就 是Shotgun
Surgery。如果需要修改的程式碼散佈四處，你不但很難找到它們，
也很容易忘記某個重要的修改。</p>

<p>這種情況下你應該使用Move Method（142）和Move
Field（146）<strong>把所有需要修改的程式碼放進同一個class</strong>。如果眼下沒有合適的class
可以安置這些程式碼，就創造一個。通常你可以運用Inline
Class（154）把一系列相關行為放進同一個class。這可能會造成少量Divergent
Change，但你可以輕易處理它。</p>

<p>Divergent Change 是指「一個class 受多種變化的影響」，Shotgun Surgery
則是指「一種變化引發多個classes
相應修改」。這兩種情況下你都會希望整理程式碼，取得「外界變化」與「待改類別」呈現一對一關係的理想境地。</p>

<h3>Feature Envy（依戀情結）</h3>

<p>物件技術的全部要點在於：這是一種「將資料和加諸其上的操作行為包裝在一起」的技術。有一種經典氣味是：<strong>函式對某個class
的興趣高過對自己所處之host
class的興趣</strong>。這種孺慕之情最通常的焦點便是資料。無數次經驗裡，我們看到某個函式為了計算某值，從另一個物件那兒呼叫幾乎半打的取值函式（getting
method）。療法顯而易見：把這個函式移至另一個地點。你應該使用Move
Method（142）把它移到它該去的地方。有時候函式中只有一部分受這種依戀之苦，這時候你應該使用Extract
Method（110）把這一部分提煉到獨立函式中，再使用Move
Method（142）帶它去它的夢中家園。</p>

<p>當然，並非所有情況都這麼簡單。一個函式往往會用上數個classes
特性，那麼它究竟該被置於何處呢？我們的原則是：判斷哪個class
擁有最多「被此函式使用」的資料，然後就把這個函式和那些資料擺在一起兒。如果先以Extract
Method（110）將這個函式分解為數個較小函式並分別置放於不同地點，上述步驟也就比較容易完成了。</p>

<p>有數個複雜精巧的範式（patterns）破壞了這個規則。說起這個話題，「四巨頭」
[Gangof Four] 的Strategy和Visitor立刻跳入我的腦海，Kent Beck的Self
Delegation[Beck] 也在此列。使用這些範式是為了對抗壞味道Divergent
Change。最根本的原則是：將總是一起變化的東西放在一塊兒。「資料」和「引用這些資料」的行為總是一起變化的，但也有例外。如果例外出現，我們就搬移那些行為，保持「變化只在一地發生」。Strategy
和Visitor
使你得以輕鬆修改函式行為，因為它們將少量需被覆寫（overridden）的行為隔離開來
— 當然也付出了「多一層間接性」的代價。</p>

<h3>Data Clumps（資料泥團）</h3>

<p>資料項（data
items）就像小孩子：喜歡成群結隊地待在一塊兒。你常常可以在很多地方看到相同的三或四筆資料項：<strong>兩個classes
內的相同欄位（field）</strong>、<strong>許多函式署名式（signature）中的相同參數</strong>。這些「總是綁在一起出現的資料」真應該放進屬於它們自己的物件中。首先請找出這些資料的欄位形式（field）出現點，運用Extract
Class（149）將它們提煉到一個獨立物件中。然後將注意力轉移到函式署名式（signature）上頭，運用Introduce
Parameter Object（295）或Preserve
WholeObject（288）為它減肥。這麼做的直接好處是可以將很多參數列縮短，簡化函式呼叫動作。是的，不必因為Data
Clumps
只用上新物件的一部分欄位而在意，只要你以新物件取代兩個（或更多）欄位，你就值回票價了。</p>

<p>一個好的評斷辦法是：刪掉眾多資料中的一筆。其他資料有沒有因而失去意義？如果它們不再有意義，這就是個明確信號：你應該為它們產生一個新物件。</p>

<p>縮短欄位個數和參數個數，當然可以去除一些壞味道，但更重要的是：一旦擁有新物件，你就有機會讓程式散發出一種芳香。得到新物件後，你就可以著手尋找Feature
Envy，這可以幫你指出「可移至新class」中的種種程式行為。不必太久，所有classes都將在它們的小小社會中充分發揮自己的生產力。</p>

<h3>Primitive Obsession（基本型別偏執）</h3>

<p>大多數編程環境都有兩種資料：結構型別（record types）允許你將資料組織成有
意義的形式；基本型別（primitive
types）則是構成結構型別的積木塊。結構總是
會帶來一定的額外開銷。它們有點像資料庫中的表格，或是那些得不償失（只為
做一兩件事而創建，卻付出太大額外開銷）的東西。</p>

<p>物件的一個極具價值的東西是：它們模糊（甚至打破）了橫亙於基本資料和體積
較大的classes 之間的界限。你可以輕鬆編寫出一些與語言內建（基本）型別無異
的小型classes。例如Java就以基本型別表示數值，而以class 表示字串和日期 —
這 兩個型別在其他許多編程環境中都以基本型別表現。</p>

<p><strong>物件技術的新手通常不願意在小任務上運用小物件 — 像是結合數值和幣別的
money class、含一個起始值和一個結束值的range
class、電話號碼或郵遞區號（ZIP） 等等的特殊strings。</strong>你可以運用Replace
Data Value with Object（175）將原本單
獨存在的資料值替換為物件，從而走出傳統的洞窟，進入炙手可熱的物件世界。
如果欲替換之資料值是type code（型別代碼），而它並不影響行為，你可以運用
Replace Type Code with Class（218）將它換掉。如果你有相依於此type
code的條 件式，可運用Replace Type Code with Subclass（213）或Replace
Type Code with State/Strategy（227）加以處理。</p>

<p>如果你有一組應該總是被放在一起的欄位（fields），可運用Extract
Class（149）。 如果你在參數列中看到基本型資料，不妨試試Introduce
Parameter Object（295）。
如果你發現自己正從array中挑選資料，可運用Replace Array with
Object（186）。</p>

<h3>Switch Statements（switch 驚悚現身）</h3>

<p>物件導向程式的一個最明顯特徵就是：<strong>少用switch（或case）述句</strong>。從本質上說，switch
述句的問題在於重複（duplication）。你常會發現同樣的switch
述句散佈於不同地點。如果要為它添加一個新的case
子句，你必須找到所有switch述句並修改它們。物件導向中的多型（polymorphism）概念可為此帶來優雅的解決辦法。</p>

<p>大多數時候，一看到switch
述句你就應該考慮以「多型」來替換它。問題是多型該出現在哪兒？switch
述句常常根據type code（型別代碼）進行選擇，你要的是「與該type
code相關的函式或class」。所以你應該使用Extract Method（110）將switch
述句提煉到一個獨立函式中，再以Move
Method（142）將它搬移到需要多型性的那個class
裡頭。此時你必須決定是否使用Replace Type Code
withSubclasses（223）或Replace Type Code with
State/Strategy（227）。一旦這樣完成繼承結構之後，你就可以運用Replace
Conditional with Polymorphism（255）了。</p>

<p>如果你只是在單一函式中有些選擇事例，而你並不想改動它們，那麼「多型」就有點殺雞用牛刀了。這種情況下Replace
Parameter with Explicit
Methods（285）是個不錯的選擇。如果你的選擇條件之一是null，可以試試Introduce
Null Object（260）。</p>

<h3>Parallel Inheritance Hierarchies（平行繼承體系）</h3>

<p>Parallel Inheritance Hierarchies其實是Shotgun
Surgery的特殊情況。在這種情況下，每當你為某個class
增加一個subclass，必須也為另一個class
相應增加一個subclass。如果你發現某個繼承體系的class
名稱字首和另一個繼承體系的class名稱字首完全相同，便是聞到了這種壞味道。</p>

<p>消除這種重複性的一般策略是：讓一個繼承體系的實體（instances）指涉（參考、引用、refer
to）另一個繼承體系的實體（instances）。如果再接再厲運用Move
Method（142）和Move Field（146），就可以將指涉端（referring
class）的繼承體系消弭於無形。</p>

<h3>Lazy Class（冗員類別）</h3>

<p>你所創建的每一個class，都得有人去理解它、維護它，這些工作都是要花錢的。<strong>如果一個class的所得不值其身價，它就應該消失</strong>。專案中經常會出現這樣的情況：某個class
原本對得起自己的身價，但重構使它身形縮水，不再做那麼多工作；或開發者事前規劃了某些變化，並添加一個class
來應付這些變化，但變化實際上沒有發生。不論上述哪一種原因，請讓這個class
莊嚴赴義吧。如果某些subclass 沒有做滿足夠工作，試試Collapse
Hierarchy（344）。對於幾乎沒用的組件，你應該以Inline
Class（154）對付它們。</p>

<h3>Speculative Generality（夸夸其談未來性）</h3>

<p>這個令我們十分敏感的壞味道，命名者是Brian
Foote。當有人說『噢，我想我們總有一天需要做這事』並因而企圖以各式各樣的掛勾（hooks）和特殊情況來處理一些非必要的事情，這種壞味道就出現了。那麼做的結果往往造成系統更難理解和維護。如果所有裝置都會被用到，那就值得那麼做；<strong>如果用不到，就不值得。</strong>用不上的裝置只會擋你的路，所以，把它搬開吧。</p>

<p>如果你的<strong>某個abstract class 其實沒有太大作用，請運用Collapse
Hierarchy（344）</strong>。<strong>非必要之delegation（委託）可運用Inline
Class（154）除掉。</strong>如果<strong>函式的某些參數未被用上，可對它實施Remove
Parameter（277）</strong>。如果函式名稱帶有多餘的抽象意味，應該對它實施Rename
Method（273）讓它現實一些。</p>

<p>如果函式或class 的惟一使用者是test
cases（測試案例），這就飄出了壞味道Speculative
Generality。如果你發現這樣的函式或class，請把它們連同其test
cases都刪掉。但如果它們的用途是幫助test
cases檢測正當功能，當然必須刀下留人。</p>

<h3>Temporary Field（令人迷惑的暫時欄位）</h3>

<p>有時你會看到這樣的物件：<strong>其內某個instance
變數僅為某種特定情勢而設</strong>。這樣的程式碼讓人不易理解，因為你通常認為物件在所有時候都需要它的所有變數。在變數未被使用的情況下猜測當初其設置目的，會讓你發瘋。</p>

<p>請使用Extract
Class（149）給這個可憐的孤兒創造一個家，然後把所有和這個變數相關的程式碼都放進這個新家。也許你還可以使用Introduce
Null Object（260）在「變數不合法」的情況下創建一個Null
物件，從而避免寫出「條件式程式碼」。</p>

<p><strong>如果class
中有一個複雜演算法，需要好幾個變數，往往就可能導致壞味道Temporary Field
的出現</strong>。由於實作者不希望傳遞一長串參數（想想為什麼），所以他把這些參數都放進欄位（fields）中。但是這些欄位只在使用該演算法時才有效，其他情況下只會讓人迷惑。這時候你可以利用Extract
Class（149）把這些變數和其相關函式提煉到一個獨立class中。提煉後的新物件將是一個method
object[Beck]（譯註：其存在只是為了提供呼叫函式的途徑，class
本身並無抽象意味）。</p>

<h3>Message Chains（過度耦合的訊息鏈）</h3>

<p>如果你看到用戶向一個物件索求（request）另一個物件，然後再向後者索求另一個物件，然後再索求另一個物件…這就是Message
Chain。實際程式碼中你看到的可能是一長串getThis()或一長串暫時變數。採行這種方式，意味客戶將與搜尋過程中的航行結構（structure
of
navigation）緊密耦合。一旦物件間的關係發生任何變化，客戶端就不得不作出相應修改。</p>

<p>這時候你應該使用Hide Delegate（157）。你可以在Message Chain
的不同位置進行這種重構手法。理論上你可以重構Message Chain
上的任何一個物件，但這麼做往往會把所有中介物件（intermediate
object）都變成Middle Man。通常更好的選擇是：先觀察Message Chain
最終得到的物件是用來幹什麼的，看看能否以Extract
Method（110）把使用該物件的程式碼提煉到一個獨立函式中，再運用MoveMethod（142）把這個函式推入Message
Chain。如果這條鏈上的某個物件有多位客戶打算航行此航線的剩餘部分，就加一個函式來做這件事。</p>

<p>有些人把任何函式鏈（method chain。譯註：就是Message
Chain；物件導向領域中所謂「發送訊息」就是「喚起函式」）都視為壞東西，我們不這樣想。呵呵，我們的冷靜鎮定是出了名的，起碼在這件事情上是這樣。</p>

<h3>Middle Man（中間轉手人）</h3>

<p>物件的基本特徵之一就是封裝（encapsulation）—
對外部世界隱藏其內部細節。封裝往往伴隨delegation（委託）。比如說你問主管是否有時間參加一個會議，他就把這個訊息委託給他的記事簿，然後才能回答你。很好，你沒必要知道這位主管到底使用傳統記事簿或電子記事簿抑或秘書來記錄自己的約會。</p>

<p>但是人們<strong>可能過度運用delegation</strong>。你也許會看到<strong>某個class
介面有一半的函式都委託給其他class，這樣就是過度運用</strong>。這時你應該使用Remove
Middle
Man（160），直接和實責物件打交道。如果這樣「不幹實事」的函式只有少數幾個，可以運用InlineMethod（117）把它們
“inlining” 放進呼叫端。如果這些Middle Man
還有其他行為，你可以運用Replace Delegation with
Inheritance（355）把它變成實責物件的subclass，這樣你既可以擴展原物件的行為，又不必負擔那麼多的委託動作。</p>

<h3>Inappropriate Intimacy（狎暱關係）</h3>

<p>有時你會看到<strong>兩個classes 過於親密，花費太多時間去探究彼此的private
成分。</strong>如果這發生在兩個「人」之間，我們不必做衛道之士；但對於classes，我們希望它們嚴守清規。</p>

<p>就像古代戀人一樣，過份狎暱的classes 必須拆散。你可以採用Move
Method（142）和Move
Field（146）幫它們劃清界線，從而減少狎暱行徑。你也可以看看是否運用Change
Bidirectional Association to Unidirectional（200）讓其中一個class
對另一個斬斷情思。如果兩個classes 實在是情投意合，可以運用Extract
Class（149）把兩者共同點提煉到一個安全地點，讓它們坦蕩地使用這個新class。或者也可以嘗試運用Hide
Delegate（157）讓另一個class 來為它們傳遞相思情。</p>

<p>繼承（inheritance）往往造成過度親密，因為subclass 對superclass
的了解總是超過superclass
的主觀願望。如果你覺得該讓這個孩子獨自生活了，請運用ReplaceInheritance
with Delegation（352）讓它離開繼承體系。</p>

<h3>Alternative Classes with Different Interfaces （異曲同工的類別）</h3>

<p>如果<strong>兩個函式做同一件事，卻有著不同的署名式（signature）</strong>，請運用Rename
Method（273）根據它們的用途重新命名。但這往往不夠，請反復運用Move
Method（142）將某些行為移入classes，直到兩者的協定（protocols）一致為止。如果你必須重複而贅餘地移入程式碼才能完成這些，或許可運用Extract
Superclass（336）為自己贖點罪。</p>

<h3>Incomplete Library Class（不完美的程式庫類別）</h3>

<p>復用（reuse）常被視為物件的終極目的。我們認為這實在是過度估計了（我們只是使用而已）。但是無可否認，許多編程技術都建立在library
classes（程式庫類別）的基礎上，沒人敢說是不是我們都把排序演算法忘得一乾二淨了。</p>

<p>library classes
構築者沒有未卜先知的能力，我們不能因此責怪他們。畢竟我們自己也幾乎總是在系統快要構築完成的時候才能弄清楚它的設計，所以library
構築者的任務真的很艱鉅。麻煩的是library
的形式（form）往往不夠好，往往不可能讓我們修改其中的classes
使它完成我們希望完成的工作。這是否意味那些經過實踐檢驗的戰術如Move
Method（142）等等，如今都派不上用場了？</p>

<p>幸好我們有兩個專門應付這種情況的工具。如果你只想修改library classes
內的一兩個函式，可以運用Introduce Foreign
Method（162）；如果想要添加一大堆額外行為，就得運用Introduce Local
Extension（164）。</p>

<h3>Data Class（純稚的資料類別）</h3>

<p>所謂Data
Class是指：<strong>它們擁有一些欄位（fields），以及用於存取（讀寫）這些欄位的函式，除此之外一無長物</strong>。這樣的classes
只是一種「不會說話的資料容器」，它們幾乎一定被其他classes
過份細瑣地操控著。這些classes
早期可能擁有public欄位，果真如此你應該在別人注意到它們之前，立刻運用Encapsulate
Field（206）將它們封裝起來。如果這些classes 內含容器類的欄位（collection
fields），你應該檢查它們是不是得到了恰當的封裝；如果沒有，就運用Encapsulate
Collection（208）把它們封裝起來。對於那些不該被其他classes
修改的欄位，請運用Remove Setting Method（300）。</p>

<p>然後，找出這些「取值/設值」函式（getting and setting
methods）被其他classes 運用的地點。嘗試以Move
Method（142）把那些呼叫行為搬移到Data
Class來。如果無法搬移整個函式，就運用Extract
Method（110）產生一個可被搬移的函式。不久之後你就可以運用Hide
Method（303）把這些「取值/設值」函式隱藏起來了。</p>

<p>Data Class
就像小孩子。作為一個起點很好，但若要讓它們像「成年（成熟）」的物件那樣參與整個系統的工作，它們就必須承擔一定責任。</p>

<h3>Refused Bequest（被拒絕的遺贈）</h3>

<p>subclasses 應該繼承superclass
的函式和資料。但如果它們不想或不需要繼承，又該怎麼辦呢？它們得到所有禮物，卻只從中挑選幾樣來玩！</p>

<p>按傳統說法，這就意味繼承體系設計錯誤。你需要為這個subclass
新建一個兄弟（sibling class），再運用Push Down Method（328）和Push Down
Field（329）把所有用不到的函式下推給那兄弟。這樣一來superclass
就只持有所有subclasses
共享的東西。常常你會聽到這樣的建議：所有superclasses
都應該是抽象的（abstract）。</p>

<p>既然使用「傳統說法」這個略帶貶義的詞，你就可以猜到，我們不建議你這麼做，起碼不建議你每次都這麼做。我們經常利用subclassing
手法來復用一些行為，並發現這可以很好地應用於日常工作。這也是一種壞味道，我們不否認，但氣味通常並不強烈。所以我們說：如果Refused
Bequest
引起困惑和問題，請遵循傳統忠告。但不必認為你每次都得那麼做。十有八九這種壞味道很淡，不值得理睬。</p>

<p>如果subclass 復用了superclass 的行為（實作），卻又不願意支援superclass
的介面，Refused Bequest 的壞味道就會變得濃烈。拒絕繼承superclass
的實作，這一點我們不介意；但如果拒絕繼承superclass
的介面，我們不以為然。不過即使你不願意繼承介面，也不要胡亂修改繼承體系，你應該運用Replace
Inheritance with Delegation（352）來達到目的。</p>

<h3>Comments（過多的註釋）</h3>

<p>別擔心，我們並不是說你不該寫註釋。從嗅覺上說，Comments不是一種壞味道；事實上它們還是一種香味呢。我們之所以要在這裡提到Comments，因為人們常把它當作除臭劑來使用。常常會有這樣的情況：你看到<strong>一段程式碼有著長長的註釋</strong>，然後發現，這些註釋之所以存在乃是因為程式碼很糟糕。這種情況的發生次數之多，實在令人吃驚。</p>

<p>Comments
可以帶我們找到本章先前提到的各種壞味道。找到壞味道後，我們首先應該以各種重構手法把壞味道去除。完成之後我們常常會發現：<strong>註釋已經變得多餘了，因為程式碼已經清楚說明了一切</strong>。</p>

<p>如果你需要註釋來解釋一塊程式碼做了什麼，試試Extract
Method（110）；如果method已經提煉出來，但還是需要註釋來解釋其行為，試試Rename
Method（273）；如果你需要註釋說明某些系統的需求規格，試試Introduce
Assertion（267）。</p>

<p>如果你不知道該做什麼，這才是註釋的良好運用時機。除了用來記述將來的打算之外，註釋還可以用來標記你並無十足把握的區域。你可以在註釋裡寫下自己「為什麼做某某事」。這類資訊可以幫助將來的修改者，尤其是那些健忘的傢伙。</p>

<p>當你感覺需要撰寫註釋，請先嘗試重構，試著讓所有註釋都變得多餘。</p>

<h2>臭味 V.S 除臭劑</h2>

<p>  壞味道（smell）                                 常用的重構手法（Common Refactoring）</p>

<hr />

<p>  Alternative Classes with Different Interfaces   Rename Method (273), Move Method (142)
  Comments                                        Extract Method (110), Introduce Assertion (267)
  Data Class                                      Move Method (142), Encapsulate Field (206),Encapsulate Collection (208)
  Data Clumps                                     Extract Class (149), Introduce Parameter Object (295),Preserve Whole Object (288)
  Divergent Change                                Extract Class (149)
  Duplicated Code                                 Extract Method (110), Extract Class (149),Pull Up Method (322), Form Template Method (345)
  Feature Envy                                    Move Method (142), Move Field (146), Extract Method (110)
  Inappropriate Intimacy                          Move Method (142), Move Field (146), Change Bidirectional Association to Unidirectional (200), Replace Inheritance with Delegation (352), Hide Delegate (157)
  Incomplete Library Class                        Introduce Foreign Method (162),Introduce Local Extension (164)
  Large Class                                     Extract Class (149), Extract Subclass (330), Extract Interface (341), Replace Data Value with Object (175)
  Lazy Class                                      Inline Class (154), Collapse Hierarchy (344)
  Long Method                                     Extract Method (110), Replace Temp With Query (120),Replace Method with Method Object (135),Decompose Conditional (238)
  Long Parameter List                             Replace Parameter with Method (292), Introduce Parameter Object (295), Preserve Whole Object (288)
  Message Chains                                  Hide Delegate (157)
  Middle Man                                      Remove Middle Man (160), Inline Method (117),Replace Delegation with Inheritance (355)
  Parallel Inheritance Hierarchies                Move Method (142), Move Field (146)
  Primitive Obsession                             Replace Data Value with Object (175), Extract Class (149),Introduce Parameter Object (295), Replace Array with Object (186), Replace Type Code with Class (218),Replace Type Code with Subclasses (223),Replace Type Code with State/Strategy (227)
  Refused Bequest                                 Replace Inheritance with Delegation (352)
  Shotgun Surgery                                 Replace Inheritance with Delegation (352)
  Speculative Generality                          Collapse Hierarchy (344), Inline Class (154),Remove Parameter (277), Rename Method (273)
  Switch Statements                               Replace Conditional with Polymorphism (255), Replace Type Code with Subclasses (223), Replace Type Code with State/Strategy (227), Replace Parameter with Explicit Methods (285), Introduce Null Object (260)
  Temporary Field                                 Extract Class (149), Introduce Null Object (260)</p>

<h2>Resource</h2>

<ul>
<li><a href="http://industriallogic.com/papers/smellstorefactorings.pdf" title="http://industriallogic.com/papers/smellstorefactorings.pdf">code
smell</a></li>
<li><a href="http://jjhou.csdn.net/jjtbooks-refactoring.htm" title="http://jjhou.csdn.net/jjtbooks-refactoring.htm">Refactoring-Improving the Design of Existing
Code(重構)</a></li>
<li><a href="http://www.refactoring.com/catalog/index.html" title="http://www.refactoring.com/catalog/index.html">Refactoring
Category</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/06/21/currying/">Currying</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-21T00:00:00+08:00" pubdate data-updated="true">Jun 21<span>st</span>, 2012</time>
        
         | <a href="/blog/2012/06/21/currying/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>柯里化(currying)是指把多個參數的單一function轉換成只使用單一參數多個functions，轉換的方式，是把參數折分後，將前一個function的執行結果傳入下一個function，
功能上的作用是讓每個function都只有一個參數，而實際上的運用是用來</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// this code taken from http://www.codecommit.com/blog/scala/function-currying-in-scala
</span><span class='line'>def add(x:Int, y:Int) = x + y
</span><span class='line'> 
</span><span class='line'>add(1, 2)   // 3
</span><span class='line'>add(7, 3)   // 10
</span><span class='line'> 
</span><span class='line'>// currying版的
</span><span class='line'> 
</span><span class='line'>def add(x:Int) = (y:Int) =&gt; x + y
</span><span class='line'> 
</span><span class='line'>add(1)(2)   // 3
</span><span class='line'>add(7)(3)   // 10</span></code></pre></td></tr></table></div></figure>


<h5>以 x = 1, y =2為例</h5>

<p>第一個版本的add
function，是add接受兩個參數(x=1,y=2)，然後相加後得到結果3</p>

<p>第二個柯里化後的add function，是第一個function <code>add(x:Int)</code>,
add(1)執行後會傳回一個整數值1，然後執行的結果1當作輸入值傳到第二個function<code>(y:Int) ⇒ x + y</code>，
(這個是一個closure，因為他有一個free variable
<code>x</code>)，x=1(來自前一個function的執行結果),y=2可得執行結果為3</p>

<h3>The Power of Currying</h3>

<p>scala為什麼需要Currying這樣的語法?因為有了Currying可以讓程式更一般化(更抽象，更通用)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// this code taken from http://www.codecommit.com/blog/scala/function-currying-in-scala
</span><span class='line'> 
</span><span class='line'>def process[A](filter:A=&gt;Boolean)(list:List[A]):List[A] = {
</span><span class='line'>  lazy val recurse = process(filter) _
</span><span class='line'> 
</span><span class='line'>  list match {
</span><span class='line'>    case head::tail =&gt; if (filter(head)) {
</span><span class='line'>      head::recurse(tail)
</span><span class='line'>    } else {
</span><span class='line'>      recurse(tail)
</span><span class='line'>    }
</span><span class='line'> 
</span><span class='line'>    case Nil =&gt; Nil
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>val even = (a:Int) =&gt; a % 2 == 0
</span><span class='line'> 
</span><span class='line'>val numbersAsc = 1::2::3::4::5::Nil
</span><span class='line'>val numbersDesc = 5::4::3::2::1::Nil
</span><span class='line'> 
</span><span class='line'>process(even)(numbersAsc)   // [2, 4]
</span><span class='line'>process(even)(numbersDesc)  // [4, 2]</span></code></pre></td></tr></table></div></figure>


<p>最後面的</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>process(even)(numbersAsc)   // [2, 4]
</span><span class='line'>process(even)(numbersDesc)  // [4, 2]</span></code></pre></td></tr></table></div></figure>


<p><code>process(even)</code>像這樣的使用方式，如果一直在程式出現，在imperative
language(命令式語言 ex:java)中，我們通常會把這個透過extract
method的重構手法，把它抽出成一個獨立的method，
那在scala中，可以把<code>process(even)</code>變成Partially Applied
Functions(在此例中為<code>val processEvens = process(even) _</code>)，然後，直接使用processEvens會將原來<code>process(even)</code>變成Currying後的第一個
function的傳回值</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// this code taken from http://www.codecommit.com/blog/scala/function-currying-in-scala
</span><span class='line'> 
</span><span class='line'>val even = (a:Int) =&gt; a % 2 == 0
</span><span class='line'>val processEvens = process(even) _
</span><span class='line'> 
</span><span class='line'>val numbersAsc = 1::2::3::4::5::Nil
</span><span class='line'>val numbersDesc = 5::4::3::2::1::Nil
</span><span class='line'> 
</span><span class='line'>processEvens(numbersAsc)   // [2, 4]
</span><span class='line'>processEvens(numbersDesc)  // [4, 2]</span></code></pre></td></tr></table></div></figure>


<h1>Resources</h1>

<ul>
<li><a href="http://gleichmann.wordpress.com/2011/12/04/functional-scala-curried-functions-and-spicy-methods/" title="http://gleichmann.wordpress.com/2011/12/04/functional-scala-curried-functions-and-spicy-methods/">http://gleichmann.wordpress.com/2011/12/04/functional-scala-curried-functions-and-spicy-methods/</a></li>
<li><a href="http://www.codecommit.com/blog/scala/function-currying-in-scala" title="http://www.codecommit.com/blog/scala/function-currying-in-scala">http://www.codecommit.com/blog/scala/function-currying-in-scala</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/30/postgresql_101/">PostgreSQL 101</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-30T00:00:00+08:00" pubdate data-updated="true">May 30<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/05/30/postgresql_101/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Command Line</h1>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>psql -U username -W</span></code></pre></td></tr></table></div></figure>


<h1>Sequence (AUTO INCREMENT)</h1>

<p>PostgreSQL並沒有自增型欄位型態^<a href="#fn__1">1)</a><sup>AUTO
INCREMENT</sup>，但是有提供Sequence機制，這部份，與<a href="http://wiki.kent-chiu.com/doku.php?id=database:oracle_101#auto_increment" title="database:oracle_101">oracle</a>比較類似，但PostgreSQL可以透過建立table時的自訂語法來自動套用Sequence，讓其動作比較接近<strong>AUTO
INCREMENT</strong>的效果</p>

<h3>使用方式</h3>

<h5>讓table的某一column套用sequence</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CREATE TABLE tablename (
</span><span class='line'>    colname SERIAL
</span><span class='line'>);</span></code></pre></td></tr></table></div></figure>


<p>上面的語法等效於</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CREATE SEQUENCE tablename_colname_seq;
</span><span class='line'>CREATE TABLE tablename (
</span><span class='line'>    colname integer DEFAULT NEXTVAL('tablename_colname_seq') NOT NULL
</span><span class='line'>);</span></code></pre></td></tr></table></div></figure>


<h5>建立sequence</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>create sequence seq start 100;</span></code></pre></td></tr></table></div></figure>


<p>以上語法會建立一個名為<code>seq</code>的sequence，啟始值為100 (從100起跳)</p>

<h5>取得目前sequence的值</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>select currval('seq');</span></code></pre></td></tr></table></div></figure>


<h5>取得下一個sequence的值</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>select nextval('seq');</span></code></pre></td></tr></table></div></figure>


<h5>重新設定sequence值</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>select setval('seq',9)</span></code></pre></td></tr></table></div></figure>


<h5>重新設定sequence值(建議)</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>select setval('seq', max(id)) FROM myTable;</span></code></pre></td></tr></table></div></figure>


<h3>Drop all tables script</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/* create a function for drop all tables */
</span><span class='line'>CREATE OR REPLACE FUNCTION drop_all_table() RETURNS SETOF RECORD   AS $$
</span><span class='line'>DECLARE
</span><span class='line'>  stmt RECORD;
</span><span class='line'>BEGIN
</span><span class='line'>    FOR stmt IN
</span><span class='line'>        /* select table */
</span><span class='line'>       SELECT c.relname FROM pg_catalog.pg_class AS c LEFT JOIN
</span><span class='line'>    pg_catalog.pg_namespace AS n ON n.oid = c.relnamespace WHERE relkind =
</span><span class='line'>    'r' AND n.nspname NOT IN ('pg_catalog', 'pg_toast') AND
</span><span class='line'>    pg_catalog.pg_table_is_visible(c.oid)
</span><span class='line'>     LOOP
</span><span class='line'>        /* drop table one by one */
</span><span class='line'>        EXECUTE 'drop table ' || quote_ident(stmt.relname) || ';';
</span><span class='line'>    END LOOP;
</span><span class='line'>END;
</span><span class='line'>$$ LANGUAGE plpgsql STRICT;
</span><span class='line'> 
</span><span class='line'>begin;
</span><span class='line'>/* execute the function */
</span><span class='line'>SELECT drop_all_table();
</span><span class='line'>commit;</span></code></pre></td></tr></table></div></figure>


<h3>Truncate all tables script</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/* create a function for drop all tables */
</span><span class='line'>CREATE OR REPLACE FUNCTION truncate_all_table() RETURNS SETOF RECORD   AS $$
</span><span class='line'>DECLARE
</span><span class='line'>  stmt RECORD;
</span><span class='line'>BEGIN
</span><span class='line'>    FOR stmt IN
</span><span class='line'>        /* select table */
</span><span class='line'>       SELECT c.relname FROM pg_catalog.pg_class AS c LEFT JOIN
</span><span class='line'>    pg_catalog.pg_namespace AS n ON n.oid = c.relnamespace WHERE relkind =
</span><span class='line'>    'r' AND n.nspname NOT IN ('pg_catalog', 'pg_toast') AND
</span><span class='line'>    pg_catalog.pg_table_is_visible(c.oid)
</span><span class='line'>     LOOP
</span><span class='line'>        /* truncate table one by one */
</span><span class='line'>        EXECUTE 'truncate table ' || quote_ident(stmt.relname) || ';';
</span><span class='line'>    END LOOP;
</span><span class='line'>END;
</span><span class='line'>$$ LANGUAGE plpgsql STRICT;
</span><span class='line'> 
</span><span class='line'>begin;
</span><span class='line'>/* execute the function */
</span><span class='line'>SELECT  truncate_all_table();
</span><span class='line'>commit;</span></code></pre></td></tr></table></div></figure>


<p>如果遇到建立script時<code>language “plpgsql” does not exist</code>(通常在linux下才會),可透過createlang命令，安裝plpgsql到指定的db</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>createlang -d &lt;dbname&gt; plpgsql</span></code></pre></td></tr></table></div></figure>


<h1>建立全新的Database</h1>

<p>從完全沒有db開始建立的流程如下</p>

<ul>
<li>pgsql/bin/initdb.exe -D <em>path</em></li>
<li><em>path</em>pg_hba.conf
設定local可以不用密碼登入(暫時性的，等設定完成記得改回來)</li>
<li>用os的帳號登入新的db
(通常是administrator)，因為上面已設定不用密碼了，所以只要os的帳號即可登入</li>
<li>登入後再建立新的database跟user</li>
<li>把<em>path</em>pg_hba.conf改回需認證才能登入</li>
</ul>


<h1>管理</h1>

<h5>列出目前活動</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>select * from pg_stat_activity ;
</span><span class='line'>
</span><span class='line'> datid | datname | procpid | usesysid | usename | current_query
</span><span class='line'>-------+---------+---------+----------+---------+---------------
</span><span class='line'> 16976 | simpydb |   31008 |      100 | otis    |
</span><span class='line'> 16976 | simpydb |   26126 |      100 | otis    |
</span><span class='line'>(2 rows)</span></code></pre></td></tr></table></div></figure>


<h1>Resource</h1>

<ul>
<li><a href="http://www.postgresql.org/docs/8.1/static/sql-createsequence.html" title="http://www.postgresql.org/docs/8.1/static/sql-createsequence.html">CREATE
SEQUENCE</a></li>
<li><a href="http://www.postgresql.org/docs/8.1/static/functions-sequence.html" title="http://www.postgresql.org/docs/8.1/static/functions-sequence.html">Sequence Manipulation
Functions</a></li>
<li><a href="http://www.postgresql.org/docs/8.0/interactive/datatype.html#DATATYPE-SERIAL" title="http://www.postgresql.org/docs/8.0/interactive/datatype.html#DATATYPE-SERIAL">PostgreSQL serial data
type</a></li>
<li><a href="http://wiki.kent-chiu.com/doku.php?id=database:oracle_101" title="database:oracle_101">Oracle
101</a></li>
</ul>


<p>^<a href="#fnt__1">1)</a>^ 每次insert時會自動讓某一特定欄位+1</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/25/effective_java_item_list/">Effective Java Item List</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-25T00:00:00+08:00" pubdate data-updated="true">May 25<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/05/25/effective_java_item_list/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This item list come for <a href="http://java.sun.com/docs/books/effective/toc.html" title="http://java.sun.com/docs/books/effective/toc.html">Effective Java Second Edition</a></p>

<h1>Creating and Destroying Objects</h1>

<h4>Item 1: Consider static factory methods instead of constructors</h4>

<h4>Item 2: Consider a builder when faced with many constructor parameters</h4>

<h4>Item 3: Enforce the singleton property with a private constructor or an enum type</h4>

<h4>Item 4: Enforce noninstantiability with a private constructor</h4>

<h4>Item 5: Avoid creating unnecessary objects</h4>

<h4>Item 6: Eliminate obsolete object references</h4>

<h4>Item 7: Avoid finalizers</h4>

<h1>Methods Common to All Objects</h1>

<h4>Item 8: Obey the general contract when overriding equals</h4>

<h4>Item 9: Always override hashCode when you override equals</h4>

<h4>Item 10: Always override toString</h4>

<h4>Item 11: Override clone judiciously</h4>

<h4>Item 12: Consider implementing Comparable</h4>

<h1>Classes and Interfaces</h1>

<h4>Item 13: Minimize the accessibility of classes and members</h4>

<h4>Item 14: In public classes, use accessor methods, not public fields</h4>

<h4>Item 15: Minimize mutability</h4>

<h4>Item 16: Favor composition over inheritance</h4>

<h4>Item 17: Design and document for inheritance or else prohibit it</h4>

<h4>Item 18: Prefer interfaces to abstract classes</h4>

<h4>Item 19: Use interfaces only to define types</h4>

<h4>Item 20: Prefer class hierarchies to tagged classes</h4>

<h4>Item 21: Use function objects to represent strategies</h4>

<h4>Item 22: Favor static member classes over nonstatic</h4>

<p>除非member classes有存取到outter class的nonstatic
method，不然，應該把member classes宣告為statics</p>

<h1>Generics</h1>

<h4>Item 23: Don&#8217;t use raw types in new code</h4>

<h4>Item 24: Eliminate unchecked warnings</h4>

<h4>Item 25: Prefer lists to arrays</h4>

<h4>Item 26: Favor generic types</h4>

<h4>Item 27: Favor generic methods</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Generic method
</span><span class='line'>public static &lt;E&gt;Set&lt;E&gt;union(Set&lt;E&gt;s1, Set&lt;E&gt;s2) {
</span><span class='line'>    Set&lt;E&gt;result = new HashSet&lt;E&gt;(s1);
</span><span class='line'>    result.addAll(s2);
</span><span class='line'>    return result;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>Item 28: Use bounded wildcards to increase API flexibility</h4>

<h4>Item 29: Consider typesafe heterogeneous containers</h4>

<p>利用加上Class&lt;T>來確定T的型別</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Typesafe heterogeneous container pattern - API
</span><span class='line'>public class Favorites {
</span><span class='line'>public &lt;T&gt; void putFavorite(Class&lt;T&gt; type, T instance);
</span><span class='line'>public &lt;T&gt; T getFavorite(Class&lt;T&gt; type);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h1>Enums and Annotations</h1>

<h4>Item 30: Use enums instead of int constants</h4>

<h4>Item 31: Use instance fields instead of ordinals</h4>

<h4>Item 32: Use EnumSet instead of bit fields</h4>

<p>如果要用位元開關的效果，可以考慮用EnumSet</p>

<h4>Item 33: Use EnumMap instead of ordinal indexing</h4>

<p>如果需要對Enum進行排序，可以用EnumMap</p>

<h4>Item 34: Emulate extensible enums with interfaces</h4>

<p>Enum是無法繼承的，如果需要類似的功能，可以考慮用interfaces</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Emulated extensible enum using an interface
</span><span class='line'>public interface Operation {
</span><span class='line'>    double apply(double x, double y);
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>public enum BasicOperation implements Operation {
</span><span class='line'>    PLUS("+") {
</span><span class='line'>        public double apply(double x, double y) {
</span><span class='line'>            return x + y;
</span><span class='line'>        }
</span><span class='line'>    },
</span><span class='line'>    MINUS("-") {
</span><span class='line'>        public double apply(double x, double y) {
</span><span class='line'>            return x - y;
</span><span class='line'>        }
</span><span class='line'>    },
</span><span class='line'>    TIMES("*") {
</span><span class='line'>        public double apply(double x, double y) {
</span><span class='line'>            return x * y;
</span><span class='line'>        }
</span><span class='line'>    },
</span><span class='line'>    DIVIDE("/") {
</span><span class='line'>        public double apply(double x, double y) {
</span><span class='line'>            return x / y;
</span><span class='line'>        }
</span><span class='line'> 
</span><span class='line'>        private final String  symbol;
</span><span class='line'> 
</span><span class='line'>        BasicOperation(String symbol) {
</span><span class='line'>            this.symbol = symbol;
</span><span class='line'>        }
</span><span class='line'> 
</span><span class='line'>        @Override
</span><span class='line'>        public String toString() {
</span><span class='line'>            return symbol;
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>};
</span><span class='line'> 
</span><span class='line'>// Emulated extension enum
</span><span class='line'>public enum ExtendedOperation implements Operation {
</span><span class='line'>    EXP("^") {
</span><span class='line'>        public double apply(double x, double y) {
</span><span class='line'>            return Math.pow(x, y);
</span><span class='line'>        }
</span><span class='line'>    },
</span><span class='line'>    REMAINDER("%") {
</span><span class='line'>        public double apply(double x, double y) {
</span><span class='line'>            return x % y;
</span><span class='line'>        }
</span><span class='line'>    };
</span><span class='line'>    private final String  symbol;
</span><span class='line'> 
</span><span class='line'>    ExtendedOperation(String symbol) {
</span><span class='line'>        this.symbol = symbol;
</span><span class='line'>    }
</span><span class='line'> 
</span><span class='line'>    @Override
</span><span class='line'>    public String toString() {
</span><span class='line'>        return symbol;
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>Item 35: Prefer annotations to naming patterns</h4>

<p>只要想到要用method
name的rule做判斷邏輯時，可以考慮用annotations或許會更彈性</p>

<h4>Item 36: Consistently use the Override annotation</h4>

<h4>Item 37: Use marker interfaces to define types</h4>

<h1>Methods</h1>

<h4>Item 38: Check parameters for validity</h4>

<h4>Item 39: Make defensive copies when needed</h4>

<h4>Item 40: Design method signatures carefully</h4>

<h4>Item 41: Use overloading judiciously</h4>

<h4>Item 42: Use varargs judiciously</h4>

<h4>Item 43: Return empty arrays or collections, not nulls</h4>

<h4>Item 44: Write doc comments for all exposed API elements</h4>

<h1>General Programming</h1>

<h4>Item 45: Minimize the scope of local variables</h4>

<h4>Item 46: Prefer for-each loops to traditional for loops</h4>

<h4>Item 47: Know and use the libraries</h4>

<h4>Item 48: Avoid float and double if exact answers are required</h4>

<h4>Item 49: Prefer primitive types to boxed primitives</h4>

<h4>Item 50: Avoid strings where other types are more appropriate</h4>

<h4>Item 51: Beware the performance of string concatenation</h4>

<h4>Item 52: Refer to objects by their interfaces</h4>

<h4>Item 53: Prefer interfaces to reflection</h4>

<h4>Item 54: Use native methods judiciously</h4>

<h4>Item 55: Optimize judiciously</h4>

<h4>Item 56: Adhere to generally accepted naming conventions</h4>

<h1>Exceptions</h1>

<h4>Item 57: Use exceptions only for exceptional conditions</h4>

<h4>Item 58: Use checked exceptions for recoverable conditions and runtime exceptions for programming errors</h4>

<p>checked exceptions應該是來被rescue的，只有能被復原的狀況，才用check
exception</p>

<h4>Item 59: Avoid unnecessary use of checked exceptions</h4>

<h4>Item 60: Favor the use of standard exceptions</h4>

<h4>Item 61: Throw exceptions appropriate to the abstraction</h4>

<h4>Item 62: Document all exceptions thrown by each method</h4>

<h4>Item 63: Include failure-capture information in detail messages</h4>

<h4>Item 64: Strive for failure atomicity</h4>

<h4>Item 65: Don&#8217;t ignore exceptions</h4>

<h1>Concurrency</h1>

<h4>Item 66: Synchronize access to shared mutable data</h4>

<h4>Item 67: Avoid excessive synchronization</h4>

<h4>Item 68: Prefer executors and tasks to threads</h4>

<h4>Item 69: Prefer concurrency utilities to wait and notify</h4>

<h4>Item 70: Document thread safety</h4>

<h4>Item 71: Use lazy initialization judiciously</h4>

<h4>Item 72: Don&#8217;t depend on the thread scheduler</h4>

<h4>Item 73: Avoid thread groups</h4>

<h1>Serialization</h1>

<h4>Item 74: Implement Serializable judiciously</h4>

<h4>Item 75: Consider using a custom serialized form</h4>

<h4>Item 76: Write readObject methods defensively</h4>

<h4>Item 77: For instance control, prefer enum types to readResolve</h4>

<h4>Item 78: Consider serialization proxies instead of serialized instances</h4>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/14/tips_and_tricks/">Android Tips & Tricks</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-14T00:00:00+08:00" pubdate data-updated="true">May 14<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/05/14/tips_and_tricks/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>WebView</h3>

<h5>讓WebView的內容符合手機的畫面</h5>

<p>webview常常需要去存取現在的網頁，但大部份的網頁沒有針對moible特別做處理，所以用手機去瀏灠網頁時(透過webview)，通常需要左右的捲動才要辦法看到完整的內容。
解決的方式為</p>

<pre><code>WebView webview = new WebView(getContext());
webview.getSettings().setLoadWithOverviewMode(true);
webview.getSettings().setUseWideViewPort(true);
</code></pre>

<h5>防止webview開成新的瀏灠器</h5>

<p>通常採用webview時，會希望webview
embbeded在客制的APP裡面，但預設的webview開啟url時，會開啟成新的完整的瀏灠器(含url
bar)，可以透過以下的code來防止這個行為。</p>

<pre><code>WebView webview = new WebView(getContext());
webview.setWebViewClient(new WebViewClient());
</code></pre>

<h5>防止Rotate後webview reload</h5>

<p>手機在直放改成橫放(或橫放改直放)時，activity會呼叫onCreate()重新建立activity，如果activity裡面webview元件，會造成weview的內容消失。
，可以在AndroidManifest.xml加入如下的設定來避免這種情現</p>

<pre><code>    &lt;activity android:name=".MyActivity" 
              android:label="@string/app_name" 
              android:configChanges="orientation|keyboard|keyboardHidden"&gt; 
</code></pre>

<h3>Storage</h3>

<h5>Internal Memory</h5>

<pre><code>Context.getFilesDir: /data/data/package_name/files
Context.getDir: /data/data/package_name/app_
Context.getCacheDir(): /data/data/package_name/cache
Environment.getDataDirectory(): /data
Environment.getDownloadCacheDirectory(): /cache
</code></pre>

<h5>SDCard</h5>

<pre><code>Environment.getExternalStoragePublicDirectory(): /mnt/sdcard
</code></pre>

<h3>Activity</h3>

<h4>Launch Mode</h4>

<p>Activity Launch Mode是<a href="http://developer.android.com/guide/topics/fundamentals/tasks-and-back-stack.html" title="http://developer.android.com/guide/topics/fundamentals/tasks-and-back-stack.html">current
task</a>怎麼去啟動的Activity的方式。
可以透過manifest或programming的方式來設定，但有些設定值，只有manifest有提供，沒辦法在runtime設定。</p>

<ol>
<li>standard
預設模組，一個activity可以有多個實體，每個實體分屬不同的task，一個task內也可存在多個實體</li>
<li>singleTop
如果有四個activies啟動在task內是<code>A→B→C→D</code>，D在最上面，一般模式下再啟動一次D會變<code>A→B→C→D→D</code>，但如果D是singleTop，不論啟動多少次D，都只會是<code>A→B→C→D</code></li>
<li>singleTask
如果不存在任何task中時，會建新另一個新的task，如果存在task中時，會呼叫其他task中的activity，並讓它成為top</li>
<li>singleInstance
永遠會建立最新的，但如果目前該activity已經是top，那就不會再建立</li>
</ol>


<h4>Handling Runtime Changes</h4>

<p>手機翻轉時，會重建整個Activity以便loading最新的配置內容，但有時，我們會希望可以保持Activity的部份狀態，要達到這個目的，可以透以下幾種機制</p>

<ol>
<li>透過 onSaveInstanceState()</li>
<li>透過 onRetainNonConfigurationInstance()</li>
<li>透過修改配置檔disable掉config change的事件</li>
</ol>


<h5>透過 onSaveInstanceState</h5>

<p>這個方式適用到保持可以序列化的值，像原生型別(數值，字串…)
主要是在onSaveInstanceState()被觸發時，把狀態保持在Intent，然後再onCreate()取得原本的狀態</p>

<h5>透過 onRetainNonConfigurationInstance</h5>

<p>onSaveInstanceState會有一個明顯的限制，就是不能處理太複雜或太大的資料，因為會做序列化，不但耗時，而且會佔不少記憶體空間。
如果要保留比較複雜的資料，可以透過onRetainNonConfigurationInstance()把物件的reference
hold住，之後，可以下次activity
restart時，透過getLastNonConfigurationInstance()取出</p>

<pre><code>@Override
public void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.main);
 
    final MyDataObject data = (MyDataObject) getLastNonConfigurationInstance();
    if (data == null) {
        data = loadMyData();
    }
    ...
}
</code></pre>

<p>要被hold住的物件不能跟context有任何關係，不然不旦會造成錯誤，還會造成memory
leaking</p>

<h5>透過修改配置檔disable掉config change的事件</h5>

<p>這種方式，是直接告訴activty要忽略某些configuration change</p>

<pre><code>&lt;activity
 android:configChanges="orientation|keyboardHidden"
</code></pre>

<p>一個簡單的翻轉動作，可能同時會觸發多次onConfigurationChanged()，所以，要把相關的設定都關掉，才不會有問題</p>

<h3>List View</h3>

<h5>下拉後更新 (Pull to refresh)</h5>

<p>在許多listview的應用裡可以見到這樣的應用</p>

<p><img src="http://blog.kent-chiu.com/images/2012-05-14/android-pull-to-refresh.png" alt="android-pull-to-refresh.png" /></p>

<p>這個效果的做法的基本原理，是在listview的header放一個layout，在偵測到listview的scroll事件後，讓layout進行動畫播放，再callback一個AsyncTask去取得資料再更新listview。</p>

<p>GitHub上有兩個這樣的library可用</p>

<ol>
<li><a href="https://github.com/johannilsson/android-pulltorefresh" title="https://github.com/johannilsson/android-pulltorefresh">https://github.com/johannilsson/android-pulltorefresh</a>

<ul>
<li>基本的list view pull to refresh</li>
</ul>
</li>
<li><a href="https://github.com/chrisbanes/Android-PullToRefresh" title="https://github.com/chrisbanes/Android-PullToRefresh">https://github.com/chrisbanes/Android-PullToRefresh</a>

<ul>
<li>這個專案目前比較活躍，另外也提供WebView, GridView,
PullToRefreshExpandableListView的下拉後更新，程式結構也比較清晰</li>
</ul>
</li>
</ol>


<h3>TextEdit</h3>

<h5>讓edit text不會一開始就彈出軟體鍵盤</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;activity android:name="MyActivity"
</span><span class='line'>          android:windowSoftInputMode="adjustUnspecified|stateHidden"
</span><span class='line'>          android:configChanges="orientation|keyboardHidden"/&gt;</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/05/jvm_profile/">JVM 記憶體調校</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-05T00:00:00+08:00" pubdate data-updated="true">May 5<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/05/05/jvm_profile/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>JVM記憶體相關參數</h4>

<ul>
<li>Xmx                        : 記憶體使用上限</li>
<li>Xms                        : 記憶體使用下限(啟始值)</li>
<li>Xss                        : stack</li>
<li>server                     :</li>
<li>client                     :</li>
<li>XX:PermSize                : Perm for Permanent:編譯後的class，或固定的資料結構會佔用這一個值</li>
<li>XX:MaxGCPauseMillis        : GC暫停的毫秒數，這個只是&#8221;建議&#8221;GC而已，GC會儘量滿足這個建議值</li>
<li>XX:+ScavengeBeforeFullGC   :</li>
<li>XX:-UseParallelOldGC       :</li>
<li>XX:NewRatio                : sets the size of the old generation to three times the size of the new generation</li>
</ul>


<p><img src="http://blog.kent-chiu.com/images/2012-05-05/jvm_profile_01.jpg" alt="jvm_profile_01.jpg" /></p>

<p>圖片來源 :<a href="http://redstack.wordpress.com/">Red Stack&#8217;s Blog</a></p>

<p>GC就是在空間不足時，將不活躍的物件從記憶體中移除，如果在GC時存活下的物件，就可能很上晉昇(Young
→ Old → Permanent)</p>

<ol>
<li>Permanent Generation:Old Generation進行GC(major GC or full
GC)後，如空間不夠，就會將Old
Generation活躍的物件(未被GC的)移到這區。建立越多的物件，此區域就要越大</li>
<li>Old Generation: 當Young Generation進行gc (minor
GC)後，空間仍舊不夠放新建立的物件時，會將Young Generation移到Old
Generation</li>
<li>New(Young) Generation():

<ol>
<li>to: Survivor space1(S1)
gc時,會將eden區未被gc的物件COPY到S1或S2區</li>
<li>from: Survivor space2(S2)
gc時,會將eden區未被gc的物件COPY到S1或S2區</li>
<li>eden: (伊甸) 看名字就知道是新生命(New
Object)誕生的地方,每new一個Object時會佔用這個區域，eden滿了，會引發gc
(minor GC)</li>
</ol>
</li>
</ol>


<p>Heap= Old Generation + New Generation</p>

<p>可以透過JDK內附的virtualVm來觀察jvm memory的使用情形</p>

<p><img src="http://blog.kent-chiu.com/images/2012-05-05/jvm_profile_02.png" alt="jvm_profile_02.png" /></p>

<h3>常用工具</h3>

<ol>
<li>jinfo</li>
<li>jmap</li>
<li>jstack</li>
<li>jstat</li>
<li>java.lang.management (API level)</li>
</ol>


<h2>Resources</h2>

<ul>
<li><a href="http://redstack.wordpress.com/2011/01/06/visualising-garbage-collection-in-the-jvm/" title="http://redstack.wordpress.com/2011/01/06/visualising-garbage-collection-in-the-jvm/">簡單而清楚的JVM
Memory教學</a></li>
<li><a href="http://www.infoq.com/cn/articles/cf-java-garbage-references" title="http://www.infoq.com/cn/articles/cf-java-garbage-references">infoQ中國站關於gc的文章(簡體中文)</a></li>
<li><a href="http://java.sun.com/docs/hotspot/gc/" title="http://java.sun.com/docs/hotspot/gc/">http://java.sun.com/docs/hotspot/gc/</a></li>
<li><a href="http://javarevisited.blogspot.com/2011/11/hotspot-jvm-options-java-examples.html" title="http://javarevisited.blogspot.com/2011/11/hotspot-jvm-options-java-examples.html">10 jvm options java developers should
know</a></li>
<li><a href="http://eclipse.org/mat/" title="http://eclipse.org/mat/">Eclipse MAT</a> -
這個比virtualVM更好用</li>
<li><a href="http://kohlerm.blogspot.com/2009/07/eclipse-memory-analyzer-10-useful.html" title="http://kohlerm.blogspot.com/2009/07/eclipse-memory-analyzer-10-useful.html">Eclipse
MAT使用的文章</a></li>
<li><a href="http://www.cubrid.org/blog/dev-platform/understanding-java-garbage-collection/" title="http://www.cubrid.org/blog/dev-platform/understanding-java-garbage-collection/">GC</a>

<ul>
<li>說明GC的機制及時機，有5種gc策略的說明</li>
</ul>
</li>
<li><a href="http://www.cubrid.org/blog/dev-platform/how-to-monitor-java-garbage-collection/" title="http://www.cubrid.org/blog/dev-platform/how-to-monitor-java-garbage-collection/">如何監控GC的教學</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/30/google_guava_101/">Google Guava 101</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-30T00:00:00+08:00" pubdate data-updated="true">Apr 30<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/04/30/google_guava_101/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Guava是google的一個開源項目，目的在提供常用工具類的API，字串處理，caching，primitives型別處理，I/O，併行(concurrnecy)處理，
還有超級好用的Collections處理。</p>

<p>本篇主要著重於<a href="http://wiki.kent-chiu.com/doku.php?id=java:google_guava_-_collection_101" title="java:google_guava_-_collection_101">Collection</a>以外相關的使用介紹，Collection的使用介紹在<a href="http://wiki.kent-chiu.com/doku.php?id=java:google_guava_-_collection_101" title="java:google_guava_-_collection_101">另一篇</a></p>

<ol>
<li><p><a href="#strings" title="java:google_guava_101 ↵">Strings</a></p>

<ol>
<li><a href="#joiner" title="java:google_guava_101 ↵">Joiner</a></li>
<li><a href="#splitter" title="java:google_guava_101 ↵">Splitter</a></li>
<li><a href="#charmatcher" title="java:google_guava_101 ↵">CharMatcher</a></li>
</ol>
</li>
<li><p><a href="#basic_utilities" title="java:google_guava_101 ↵">Basic Utilities</a></p></li>
<li><a href="#caches" title="java:google_guava_101 ↵">Caches</a></li>
<li><a href="#concurrency" title="java:google_guava_101 ↵">Concurrency</a></li>
<li><a href="#primitives" title="java:google_guava_101 ↵">Primitives</a></li>
<li><a href="#ranges" title="java:google_guava_101 ↵">Ranges</a></li>
<li><a href="#hashing" title="java:google_guava_101 ↵">Hashing</a></li>
<li><a href="#eventbus" title="java:google_guava_101 ↵">EventBus</a></li>
<li><a href="#math" title="java:google_guava_101 ↵">Math</a></li>
</ol>


<h1>Strings</h1>

<ul>
<li><a href="http://guava-libraries.googlecode.com/svn/trunk/javadoc/com/google/common/base/CaseFormat.html" title="http://guava-libraries.googlecode.com/svn/trunk/javadoc/com/google/common/base/CaseFormat.html">CaseFormat</a></li>
<li><a href="http://guava-libraries.googlecode.com/svn/trunk/javadoc/com/google/common/base/CharMatcher.html" title="http://guava-libraries.googlecode.com/svn/trunk/javadoc/com/google/common/base/CharMatcher.html">CharMatcher</a></li>
<li><a href="http://guava-libraries.googlecode.com/svn/trunk/javadoc/com/google/common/base/Charsets.html" title="http://guava-libraries.googlecode.com/svn/trunk/javadoc/com/google/common/base/Charsets.html">Charsets</a></li>
<li><a href="http://guava-libraries.googlecode.com/svn/trunk/javadoc/com/google/common/base/Joiner.html" title="http://guava-libraries.googlecode.com/svn/trunk/javadoc/com/google/common/base/Joiner.html">Joiner</a></li>
<li><a href="http://guava-libraries.googlecode.com/svn/trunk/javadoc/com/google/common/base/Splitter.html" title="http://guava-libraries.googlecode.com/svn/trunk/javadoc/com/google/common/base/Splitter.html">Splitter</a></li>
<li><a href="http://guava-libraries.googlecode.com/svn/trunk/javadoc/com/google/common/base/Strings.html" title="http://guava-libraries.googlecode.com/svn/trunk/javadoc/com/google/common/base/Strings.html">Strings</a></li>
</ul>


<h5>CharMatcher</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CharMatcher.is('.').replaceFrom(aStr, '_');                                       // 將字串中的'.'換成'_'
</span><span class='line'>CharMatcher.DIGIT.matchesAllOf("1231212");                                        // true
</span><span class='line'>CharMatcher.DIGIT.matchesAnyOf("1231 aa212");                                     // true
</span><span class='line'>CharMatcher.DIGIT.retainFrom("Hello 1234 567");                                   // "1234567";
</span><span class='line'>CharMatcher.DIGIT.or(CharMatcher.WHITESPACE).retainFrom("Hello 1234 567");        // " 1234 567"
</span><span class='line'>CharMatcher.inRange('3', '6').removeFrom("Hello 1234 567");                       // "Hello 12 7";
</span><span class='line'>CharMatcher.is('$').trimFrom("$$$ This is a $ sign $$$");                         // " This is a $ sign "
</span><span class='line'>CharMatcher.is('$').or(CharMatcher.is(' ')).trimFrom("$$$ This is a $ sign $$$"); // "This is a $ sign"</span></code></pre></td></tr></table></div></figure>


<h5>Joiner</h5>

<p>字串相加</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Joiner joiner = Joiner.on("; ").skipNulls();
</span><span class='line'>return joiner.join("Harry", null, "Ron", "Hermione"); // "Harry; Ron; Hermione"
</span><span class='line'> 
</span><span class='line'>numbersWords.put(1, "one");
</span><span class='line'>numbersWords.put(2, "two");
</span><span class='line'>numbersWords.put(3, null);
</span><span class='line'>numbersWords.put(4, "four");
</span><span class='line'>Joiner.on(" | ").withKeyValueSeparator(" -&gt; ")
</span><span class='line'>    .useForNull("Unknown").join(numbersWords)); // 1 -&gt; one | 2 -&gt; two | 3 -&gt; Unknown | 4 -&gt; four"</span></code></pre></td></tr></table></div></figure>


<h5>Splitter</h5>

<p>字串分割</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Splitter.on(',')
</span><span class='line'>       .trimResults()
</span><span class='line'>       .omitEmptyStrings()
</span><span class='line'>       .split("foo,bar,,   qux");</span></code></pre></td></tr></table></div></figure>


<h1>Basic Utilities</h1>

<h3>Optional (Null處理)</h3>

<p>java對null的處理不是很友善，所以常常需要去對null值特別處理，而Optional就是用來處理null問題的利器。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// 是否是常看到這樣的code
</span><span class='line'>if (foo == null) {
</span><span class='line'>  // do something
</span><span class='line'>} else {
</span><span class='line'>  // do something
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>// servlet總會遇到這個
</span><span class='line'>String username;
</span><span class='line'>if (request.getParameter("username") == null) {
</span><span class='line'>    username = "Stranger";
</span><span class='line'>} else {
</span><span class='line'>   username = request.getParameter("username");
</span><span class='line'>}
</span><span class='line'> 
</span><span class='line'>// 或者
</span><span class='line'>String username = request.getParameter("username") == null ? "Stranger" : request.getParameter("username");</span></code></pre></td></tr></table></div></figure>


<p>如果改用Optional的話</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Optional.of(request.getParameter("username")).or("default");</span></code></pre></td></tr></table></div></figure>


<p>這個class我個人滿少用的，它的一些延伸用法不是很直覺</p>

<h3>Preconditions</h3>

<p>前置條件檢查，通常會在在method的最前面，用來保證參數或變數在一定的狀態，如果不在預期的狀況，就拋出異常。</p>

<ol>
<li>checkArgument(boolean) : 用來檢查method的參數，不為true則拋出
IllegalArgumentException</li>
<li>checkNotNull(T) : 如果是 null 拋出 NullPointerException</li>
<li>checkState(boolean) :
跟checkArgument(boolean)很像，但用來檢查非參數的變數，如果不為true，拋出
IllegalStateException</li>
<li>checkElementIndex(int index, int size) :
用來檢查List,Array或字串index的合法性，不合法就拋出
IndexOutOfBoundsException</li>
<li>checkPositionIndex(int index, int size) :
用來檢查List,Array或字串index的合法性，不合法就拋出
IndexOutOfBoundsException</li>
<li>checkPositionIndexes(int start, int end, int size) :
用來檢查List,Array或字串index的合法性，不合法就拋出
IndexOutOfBoundsException</li>
</ol>


<p>checkElementIndex,checkPositionIndex,checkPositionIndexes用法比較特別，它不需要傳入List,Array或字串本身，只需傳入List,Array或字串的index，size，或start，end</p>

<h3>Ordering</h3>

<p>排序用，如果要被排序的元素本身已有<a href="http://wiki.kent-chiu.com/doku.php?id=java:google_guava_101" title="java:google_guava_101">Comparator</a>的話，可以直做透過Ordering做排序,
如果沒有，也可以extends Ordering達到排序的效果。</p>

<h3>Object methods</h3>

<p>傳統的Comparable實作方式很煩人，而且容易出錯</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class Person implements Comparable&lt;Person&gt; {
</span><span class='line'>  private String lastName;
</span><span class='line'>  private String firstName;
</span><span class='line'>  private int zipCode;
</span><span class='line'> 
</span><span class='line'>  public int compareTo(Person other) {
</span><span class='line'>    int cmp = lastName.compareTo(other.lastName);
</span><span class='line'>    if (cmp != 0) {
</span><span class='line'>      return cmp;
</span><span class='line'>    }
</span><span class='line'>    cmp = firstName.compareTo(other.firstName);
</span><span class='line'>    if (cmp != 0) {
</span><span class='line'>      return cmp;
</span><span class='line'>    }
</span><span class='line'>    return Integer.compare(zipCode, other.zipCode);
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Guava提供ComparisonChain簡化Comparable.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>   public int compareTo(Foo that) {
</span><span class='line'>     return ComparisonChain.start()
</span><span class='line'>         .compare(this.aString, that.aString)
</span><span class='line'>         .compare(this.anInt, that.anInt)
</span><span class='line'>         .compare(this.anEnum, that.anEnum, Ordering.natural().nullsLast())
</span><span class='line'>         .result();
</span><span class='line'>   }</span></code></pre></td></tr></table></div></figure>


<h3>Throwables</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> try {
</span><span class='line'>     someMethodThatCouldThrowAnything();
</span><span class='line'>   } catch (IKnowWhatToDoWithThisException e) {
</span><span class='line'>     handle(e);
</span><span class='line'>   } catch (Throwable t) {
</span><span class='line'>     Throwables.propagateIfInstanceOf(t, IOException.class);
</span><span class='line'>     Throwables.propagateIfInstanceOf(t, SQLException.class);
</span><span class='line'>     throw Throwables.propagate(t);
</span><span class='line'>   }</span></code></pre></td></tr></table></div></figure>


<h1>Caches</h1>

<p>Guava Cache很像Map，但在使用上跟行為上還是跟Map有許多不同之類。Guava
Cache只會暫存在Memory(RAM)，不會儲存 在local file system.</p>

<p>建立cache有兩種方式，一種是一開始就load所需要的資料，另一種是如果資料不存在就建立，否則就直接取cache內的資料</p>

<h5>CacheLoader是在開始時就建立好cache的資料</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>LoadingCache&lt;Key, Graph&gt; graphs = CacheBuilder.newBuilder()
</span><span class='line'>        .maximumSize(10000)
</span><span class='line'>        .expireAfterWrite(10, TimeUnit.MINUTES)
</span><span class='line'>        .removalListener(MY_LISTENER)
</span><span class='line'>        .build(
</span><span class='line'>            new CacheLoader&lt;Key, Graph&gt;() {
</span><span class='line'>                public Graph load(Key key) throws AnyException {
</span><span class='line'>                return createExpensiveGraph(key);
</span><span class='line'>            }
</span><span class='line'>        });</span></code></pre></td></tr></table></div></figure>


<h5>Callable是取不到資料時就建立cache</h5>

<p>當執行cache.get，如果有cache就會從cache取，如果沒有cache就會建立一份到cache中</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Cache&lt;Key, Value&gt; cache = CacheBuilder.newBuilder()
</span><span class='line'>    .maximumSize(1000)
</span><span class='line'>    .build(); // look Ma, no CacheLoader
</span><span class='line'>...
</span><span class='line'>try {
</span><span class='line'>  // If the key wasn't in the "easy to compute" group, we need to
</span><span class='line'>  // do things the hard way.
</span><span class='line'>  cache.get(key, new Callable&lt;Value&gt;() {
</span><span class='line'>    @Override
</span><span class='line'>    public Value call() throws AnyException {
</span><span class='line'>      return doThingsTheHardWay(key);
</span><span class='line'>    }
</span><span class='line'>  };
</span><span class='line'>} catch (ExecutionException e) {
</span><span class='line'>  throw new OtherException(e.getCause());
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h1>Concurrency</h1>

<p>ListenableFuture Service Using Implementations Monitor</p>

<h1>Primitives</h1>

<p>Primitive arrays General utilities Byte conversion Unsigned support</p>

<h1>Ranges</h1>

<p>用來處理一個範圍內class，主要是透過<a href="http://docs.oracle.com/javase/7/docs/api/java/lang/Comparable.html" title="http://docs.oracle.com/javase/7/docs/api/java/lang/Comparable.html">Comparable</a>來做範圍的運算，
所以不一定是要數值型的class才能做Range，像有實作Comparable的日期也是可以做範圍處理。</p>

<p>可透過Ranges類別來建立Range</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Ranges.closed(1,10);</span></code></pre></td></tr></table></div></figure>


<h1>EventBus</h1>

<p>EventBus是guava的事件處理，但不像傳統的Event-Listener那樣需要implement
xxxListener那樣(結果就是產生了一堆inner class或anonymous inner class)
而是透過@Annotation的方式處理。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Class is typically registered by the container.
</span><span class='line'>class EventBusChangeRecorder {
</span><span class='line'>  @Subscribe void recordCustomerChange(ChangeEvent e) {
</span><span class='line'>    recordChange(e.getChange());
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>// somewhere during initialization
</span><span class='line'>eventBus.register(new EventBusChangeRecorder());
</span><span class='line'>// much later
</span><span class='line'>public void changeCustomer() {
</span><span class='line'>  ChangeEvent event = getChangeEvent();
</span><span class='line'>  eventBus.post(event);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>Reference</h4>

<ol>
<li><a href="http://codingjunkie.net/guava-eventbus/" title="http://codingjunkie.net/guava-eventbus/">http://codingjunkie.net/guava-eventbus/</a></li>
<li><a href="http://tomaszdziurko.pl/2012/01/google-guava-eventbus-easy-elegant-publisher-subscriber-cases/" title="http://tomaszdziurko.pl/2012/01/google-guava-eventbus-easy-elegant-publisher-subscriber-cases/">http://tomaszdziurko.pl/2012/01/google-guava-eventbus-easy-elegant-publisher-subscriber-cases/</a></li>
</ol>


<h1>Math</h1>

<p>TBD</p>

<h1>Resources</h1>

<ul>
<li><a href="http://code.google.com/p/guava-libraries/" title="http://code.google.com/p/guava-libraries/">Guava
Home</a></li>
<li><a href="http://code.google.com/p/guava-libraries/wiki/ExplainedContents" title="http://code.google.com/p/guava-libraries/wiki/ExplainedContents">各功能的使用介紹</a>
(推薦)</li>
<li><a href="http://jnb.ociweb.com/jnb/jnbApr2010.html" title="http://jnb.ociweb.com/jnb/jnbApr2010.html">Examples</a></li>
<li><a href="http://jnb.ociweb.com/jnb/jnbFeb2009.html" title="http://jnb.ociweb.com/jnb/jnbFeb2009.html">Google
Collections</a></li>
<li><a href="http://www.copperykeenclaws.com/googles-guava-java-the-easy-parts/" title="http://www.copperykeenclaws.com/googles-guava-java-the-easy-parts/">Google’s guava java: the easy
parts</a></li>
<li><a href="http://stackoverflow.com/questions/tagged/guava" title="http://stackoverflow.com/questions/tagged/guava">guava on
stackoverflow</a></li>
<li>Using the Google Collections Library for Java
<a href="http://www.youtube.com/watch?v=ZeO_J2OcHYM" title="http://www.youtube.com/watch?v=ZeO_J2OcHYM">part1</a>
<a href="http://www.youtube.com/watch?v=9ni_KEkHfto" title="http://www.youtube.com/watch?v=9ni_KEkHfto">part2</a></li>
<li>带你领略 Google Collections <a href="http://jubin2002.javaeye.com/blog/471661" title="http://jubin2002.javaeye.com/blog/471661">part
1</a>
<a href="http://jubin2002.javaeye.com/blog/471698" title="http://jubin2002.javaeye.com/blog/471698">part
2</a></li>
<li>MapMaker Usage
<a href="http://norther.javaeye.com/blog/670414" title="http://norther.javaeye.com/blog/670414">http://norther.javaeye.com/blog/670414</a></li>
<li><a href="http://www.ibm.com/developerworks/cn/java/j-lo-googlecollection/index.html?ca=drs-" title="http://www.ibm.com/developerworks/cn/java/j-lo-googlecollection/index.html?ca=drs-">Google Guava Collections
使用介绍</a>

<ul>
<li>IBM 中國上介紹guava的文章</li>
</ul>
</li>
<li><a href="http://www.tfnico.com/presentations/google-guava" title="http://www.tfnico.com/presentations/google-guava">一些guava使用上的介紹</a></li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/4/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/2/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/07/07/python-101/">Python 101</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/25/url-encoding/">URL Encoding</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/04/restful-api-design/">RESTful API Design</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/17/my-intellij-idea-shortcut/">My IntelliJ IDEA Shortcut</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/12/jesper-report-font-issue/">Jesper Report, IReport 匯出成中文PDF</a>
      </li>
    
  </ul>
</section>

Included file &#8216;asides/twitter.html&#8217; not found in _includes directory



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Kent -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'kentchiu';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
