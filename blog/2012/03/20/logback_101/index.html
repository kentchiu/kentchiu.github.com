
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Logback 101 - Kent's Blog</title>
  <meta name="author" content="Kent">

  
  <meta name="description" content="在使用log4j時，遇到幾個問題，剛好這個幾個問題是logback特別強調他可以解決的(所以，我們應該是遇到了大多數使用log4j的開發人員會遇到的麻煩)。
而且，一直以為都是使用SLF4J當作logger的API(slf4j底層是呼叫log4j)，logback也可以無痛轉換， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.kent-chiu.com/blog/2012/03/20/logback_101">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Kent's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-39152849-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Kent's Blog</a></h1>
  
    <h2>Kent的學習筆記</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.kent-chiu.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Logback 101</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-20T00:00:00+08:00" pubdate data-updated="true">Mar 20<span>th</span>, 2012</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>在使用log4j時，遇到幾個問題，剛好這個幾個問題是<a href="http://logback.qos.ch/index.html" title="http://logback.qos.ch/index.html">logback</a>特別強調他可以解決的(所以，我們應該是遇到了大多數使用log4j的開發人員會遇到的麻煩)。
而且，一直以為都是使用<a href="http://www.slf4j.org/" title="http://www.slf4j.org/">SLF4J</a>當作logger的API(slf4j底層是呼叫log4j)，logback也可以無痛轉換，所以就試著把Log4j換成logback</p>

<p>Appender Additivity(疊加)是一個很常用的功能，官網上對它的說明是這樣的</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Appender Additivity
</span><span class='line'> 
</span><span class='line'>The output of a log statement of logger L will go to all the appenders in L and its ancestors. This is the meaning of the term "appender additivity".
</span><span class='line'> 
</span><span class='line'>However, if an ancestor of logger L, say P, has the additivity flag set to false, then L's output will be directed to all the appenders in L and its ancestors up to and including P but not the appenders in any of the ancestors of P.
</span><span class='line'> 
</span><span class='line'>Loggers have their additivity flag set to true by default.</span></code></pre></td></tr></table></div></figure>


<p>example</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  Logger Name       Attached Appenders   Additivity Flag   Output Targets           Comment
</span><span class='line'>  ----------------- -------------------- ----------------- ------------------------ ---------------------------------------root              A1                   not applicable    A1                       Since the root logger stands at the top of the logger hierarchy, the additivity flag does not apply to it.
</span><span class='line'>  x                 A-x1, A-x2           true              A1, A-x1, A-x2           Appenders of “x” and of root.
</span><span class='line'>  x.y               none                 true              A1, A-x1, A-x2           Appenders of “x” and of root.
</span><span class='line'>  x.y.z             A-xyz1               true              A1, A-x1, A-x2, A-xyz1   Appenders of “x.y.z”, “x” and of root.
</span><span class='line'>  security          A-sec                false             A-sec                    No appender accumulation since the additivity flag is set to “false”. Only appender A-sec will be used.
</span><span class='line'>  security.access   none                 true              A-sec                    Only appenders of “security” because the additivity flag in “security” is set to “false”.</span></code></pre></td></tr></table></div></figure>


<p>基本上，也就是設定<code>Additivity=false</code>時，該logger所宣告的所有appenders不會附加到parent上面(常用來抑制logging到root)，其子logger也不會繼承這個logger所宣告的appenders。</p>

<h4>在配置檔使用變數</h4>

<p>配置檔內可以透過<code>&lt;property&gt;</code>
tag來定義變數，並透過<code>${變數名稱}</code>來引用它。系統變數也可以直接使用，像<code>${user.home}</code>，另外，也可以用一個獨立的屬性檔(filename.properties)來定義屬性，之後再引入
<code>&lt;property file=“filename.properties” /&gt;</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;configuration&gt;
</span><span class='line'> 
</span><span class='line'>  &lt;property name="USER_HOME" value="/home/sebastien" /&gt;
</span><span class='line'> 
</span><span class='line'>  &lt;appender name="FILE" class="ch.qos.logback.core.FileAppender"&gt;
</span><span class='line'>    &lt;file&gt;${USER_HOME}/myApp.log&lt;/file&gt;
</span><span class='line'>    &lt;encoder&gt;
</span><span class='line'>      &lt;pattern&gt;%msg%n&lt;/pattern&gt;
</span><span class='line'>    &lt;/encoder&gt;
</span><span class='line'>  &lt;/appender&gt;
</span><span class='line'> 
</span><span class='line'>  &lt;root level="debug"&gt;
</span><span class='line'>    &lt;appender-ref ref="FILE" /&gt;
</span><span class='line'>  &lt;/root&gt;
</span><span class='line'>&lt;/configuration&gt;</span></code></pre></td></tr></table></div></figure>


<p>如果定義的變數需要預設使，那可以透過<code>:-</code>符號，ex:
<code>${aKey:-golden}</code>，如果aKey是null，那就會用<strong>golden</strong>取代</p>

<h1>Log4j to Logback porting筆記</h1>

<h3>換掉library</h3>

<p>專案是用maven管理的，所以，換lib相當簡單，到<a href="http://search.maven.org/" title="http://search.maven.org/">maven的lib搜尋引擎</a>找出最新的logback，換上即可</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;dependency&gt;
</span><span class='line'>    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
</span><span class='line'>    &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;
</span><span class='line'>    &lt;version&gt;1.6.3&lt;/version&gt;
</span><span class='line'>&lt;/dependency&gt;
</span><span class='line'>&lt;dependency&gt;
</span><span class='line'>    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
</span><span class='line'>    &lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;
</span><span class='line'>    &lt;version&gt;1.6.3&lt;/version&gt;
</span><span class='line'>&lt;/dependency&gt;</span></code></pre></td></tr></table></div></figure>


<h5>換成</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;dependency&gt;
</span><span class='line'>    &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
</span><span class='line'>    &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;
</span><span class='line'>    &lt;version&gt;0.9.30&lt;/version&gt;
</span><span class='line'>&lt;/dependency&gt;</span></code></pre></td></tr></table></div></figure>


<h5>結果</h5>

<p>因為之前都是slf4j寫的，完全不用改code，但是連其他lib裡的logger都輸出到console了(logback會有一個預設的設定檔，所以，不需要像log4j一樣，一定要給log4.xml或log4j.properties)
但是用預設的設定，會連其它freamwork的log訊息一起輸出(像hibernate)，log4j在沒有配置檔時，會吐出設定檔不存在的訊息，但是logback則會以預設(內建)的配置檔做設定。</p>

<h3>使用客製的配置檔</h3>

<p>logback會在classpath下依序尋找</p>

<ol>
<li>logback.groovy (logback可以用groovy當設定檔)</li>
<li>logback-test.xml (通常用於測試)</li>
<li>logback.xml (一般是用這個)</li>
<li><a href="http://logback.qos.ch/xref/ch/qos/logback/classic/BasicConfigurator.html" title="http://logback.qos.ch/xref/ch/qos/logback/classic/BasicConfigurator.html">BasicConfigurator</a>
如果上面三個都不存在時，會用這個class的內容當作配置檔(預設)</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;configuration  scan="true" scanPeriod="30 seconds" &gt; 
</span><span class='line'> 
</span><span class='line'>  &lt;appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender"&gt;
</span><span class='line'>    &lt;!-- encoders are assigned the type
</span><span class='line'>         ch.qos.logback.classic.encoder.PatternLayoutEncoder by default --&gt;
</span><span class='line'>    &lt;encoder&gt;
</span><span class='line'>      &lt;pattern&gt;%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n&lt;/pattern&gt;
</span><span class='line'>    &lt;/encoder&gt;
</span><span class='line'>  &lt;/appender&gt;
</span><span class='line'> 
</span><span class='line'>  &lt;root level="debug"&gt;
</span><span class='line'>    &lt;appender-ref ref="STDOUT" /&gt;
</span><span class='line'>  &lt;/root&gt;
</span><span class='line'>&lt;/configuration&gt;</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;configuration  
</span><span class='line'>  scan="true"                 // 更改配置檔內容時，不用重啟程式
</span><span class='line'>  scanPeriod="30 seconds"     // 多久偵測一次變更
</span><span class='line'>&gt; </span></code></pre></td></tr></table></div></figure>


<h5>Rolling Appender</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  &lt;appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender"&gt;
</span><span class='line'>        &lt;file&gt;${USER_HOME}/foo.log&lt;/file&gt;
</span><span class='line'>        &lt;rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy"&gt;
</span><span class='line'>            &lt;!-- daily rollover --&gt;
</span><span class='line'>            &lt;fileNamePattern&gt;${USER_HOME}/foo.%d{yyyy-MM-dd}.log&lt;/fileNamePattern&gt;
</span><span class='line'>            &lt;!-- keep 120 days' worth of history --&gt;
</span><span class='line'>            &lt;maxHistory&gt;120&lt;/maxHistory&gt;
</span><span class='line'>        &lt;/rollingPolicy&gt;
</span><span class='line'>        &lt;encoder&gt;
</span><span class='line'>            &lt;pattern&gt;%d{HH:mm:ss.SSS} [%thread] %-5level %30.20logger{0}.%-30method - %msg%n&lt;/pattern&gt;
</span><span class='line'>        &lt;/encoder&gt;
</span><span class='line'>    &lt;/appender&gt;</span></code></pre></td></tr></table></div></figure>


<p>讓Logger周期性的改名成舊版(Rolling)是一個很常見的需求，像是每天午夜12點整，把log改名成前一日的日期，然後當日的log則從新檔開始，這樣可以避免單一的log檔過大，
這樣的行為，我們叫Daily Rolling。</p>

<p>LogBack的Rolling的設定上很直覺，只要設定fileNamePattern中的日期格式，它就會依設定日期格式的最小單位做Rolling。但要注意的是如果<code>&lt;appender&gt;&lt;file&gt;</code>tag有設定路徑，那<code>&lt;fileNamePattern&gt;</code>也要設定相同的路徑，這樣可以讓舊的log(有包含日期的檔名)跟新的log(作用中的log)在同一個目錄</p>

<p>這樣設定後，在使用者的家目錄下，可以看到類似下面的檔案列要</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>foo.log   // 作用中的log
</span><span class='line'>foo.2012-01-01.log 
</span><span class='line'>foo.2012-01-02.log 
</span><span class='line'>foo.2012-01-03.log 
</span><span class='line'>foo.2012-01-04.log 
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<h3>TBD</h3>

<ul>
<li>出異常時，自動修改設定檔，讓其輸出錯誤細節</li>
</ul>


<h1>Resource</h1>

<ul>
<li><a href="http://logback.qos.ch/" title="http://logback.qos.ch/">官網</a></li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Kent Chiu</span></span>

      








  


<time datetime="2012-03-20T00:00:00+08:00" pubdate data-updated="true">Mar 20<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/java/'>java</a>, <a class='category' href='/blog/categories/logger/'>logger</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://blog.kent-chiu.com/blog/2012/03/20/logback_101/" data-via="" data-counturl="http://blog.kent-chiu.com/blog/2012/03/20/logback_101/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/03/20/listview_style/" title="Previous Post: ListView Style">&laquo; ListView Style</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/03/20/media_player/" title="Next Post: Android Media Player">Android Media Player &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/07/15/mac-os-x-keyboard-shortcuts-for-terminal/">Mac OS X Keyboard Shortcuts for Terminal</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/17/my-intellij-idea-shortcut/">My IntelliJ IDEA Shortcut</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/12/jesper-report-font-issue/">Jesper Report, IReport 匯出成中文PDF</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/12/jasperreport-101/">JasperReport 101</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/06/mac-tips/">Mac Tips</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Kent -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'kentchiu';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.kent-chiu.com/blog/2012/03/20/logback_101/';
        var disqus_url = 'http://blog.kent-chiu.com/blog/2012/03/20/logback_101/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
