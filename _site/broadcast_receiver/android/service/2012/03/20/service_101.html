<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width initial-scale=1">

  <title>Android Service 101</title>
  <meta name="description" content="Table of contents">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://blog.kent-chiu.com//broadcast_receiver/android/service/2012/03/20/service_101.html">
  <link rel="alternate" type="application/atom+xml" title="Kent's Blog" href="http://blog.kent-chiu.com//feed.xml" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Kent's Blog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Android Service 101</h1>
    <p class="post-meta">Mar 20, 2012 • Kent Chiu</p>
  </header>

  <article class="post-content">
    <h1 class="no_toc" id="table-of-contents">Table of contents</h1>

<ul id="markdown-toc">
  <li><a href="#service">Service</a></li>
  <li><a href="#intent-service">Intent Service</a></li>
  <li><a href="#remote-service">Remote Service</a></li>
  <li><a href="#bound-service">Bound Service</a>    <ul>
      <li><a href="#service-1">開機後自動啟動的Service</a></li>
    </ul>
  </li>
  <li><a href="#resources">Resources</a></li>
</ul>

<hr />

<p>Android<br />
Service可以視為Windows的系統服務或Linux的Daemons，可以長時間在存在系統中(不一定要直在活動狀態)，而且，他有自已的生命周期，不會隨著Activity的消滅而消滅。</p>

<p>Android有兩種類型的services</p>

<ol>
  <li>Local Service</li>
  <li>Remote Service (透過AIDL定義)</li>
</ol>

<p>Local Service是應用程式自已內部要使用的service，而Remote Service則可提供給其他應用程式使用。Service執行時，一樣是執行在Main Thread(UI Thread)，所以，service會影響到UI的操作效能，如果service執行的時間很短，那問題不大，一但service要執行很久的時間，那應該要採用<a href="http://blog.kent-chiu.com/blog/2012/03/19/background_processing&quot;">背景服務</a>的方式來處理。</p>

<p>如果想讓serivce裡的worker thread只有一個instance，可以在oncreate建立，這樣就能讓thread instance(或者是<a href="http://developer.android.com/reference/java/util/concurrent/ExecutorService.html" title="http://developer.android.com/reference/java/util/concurrent/ExecutorService.html">ExecutorService</a>)只有一份</p>

<p>Android有提供另一個跟Service一樣，適合在背景作業的機制叫<a href="http://developer.android.com/reference/android/content/BroadcastReceiver.html" title="http://developer.android.com/reference/android/content/BroadcastReceiver.html">Broadcast Receiver</a>，至於何時該用Servce，何時該用Broadcast Receiver可以參考<a href="http://developer.android.com/resources/articles/multitasking-android-way.html" title="http://developer.android.com/resources/articles/multitasking-android-way.html">這篇</a>文章</p>

<h4 id="service">Service</h4>

<p>下例是一個簡單的service，<code>onBind()</code>如果不是要做<em>Bound<br />
Service</em>的話，就直接return null即可，而<code>onStartCommand()</code>則是service主要要實作的部份<br />
，依收到的intent去決定要實作那些功能，如果比較耗時的功能，記得用<a href="&quot;http://blog.kent-chiu.com/blog/2012/03/19/background_processing/&quot;">背景作業處理</a>處理，因為service<strong>並不是執行在另一個thread</strong>。</p>

<p>如果想讓Service執行成另一個獨立的process，可以透過設定service的xml中的process屬性，像這樣</p>

<pre><code>&lt;service
    android:name="WordService"
    android:process=":my_process" 
    android:icon="@drawable/icon"
    android:label="@string/service_name"
    &gt;
&lt;/service&gt;

</code></pre>

<p>Service的啟動與停止是透過Context中的<code>startService(Intent)</code>及<code>stopService(Intent service)</code>，Activity,Service跟Application都是繼承自Context，所以可以直接呼叫。</p>

<p>比較值得注意的地方為<code>onStartCommand()</code>的傳回值部份，這個跟Service Life<br />
cycle有關。在系統需要資源時，系統可能會把service給kill掉，而之後等系統比較有空時，<br />
會再自動把service給叫回來，但這個行為，可以透過指定<code>onStartCommand()</code>的傳回值來改變，有效的傳回值有:</p>

<ol>
  <li>START_STICKY :<br />
預設的行為，service被系統kill掉後或做完工作後，系統會restart service，一般要停止service話，是透過stopService()，或stopSelf()</li>
  <li>START_NOT_STICKY : 如果service做完工作後，系統會stop service，而不是restart service，這個很適用來做周期的工作(比如說每15分鐘檢查一次mail<br />
box)，而不是一直不斷執行的任務，下次收到intent</li>
  <li>START_REDELIVER_INTENT :<br />
跟START_NOT_STICKY很像，這個適合用來做失敗時會再重做n次的工作，它會在工作沒能成功做完時再次呼叫自己</li>
</ol>

<pre><code>	public class MyService extends Service {
	
	    @Override
	    public IBinder onBind(Intent intent) {
	        return null;
	    }
	 
	    @Override
	    public int onStartCommand(Intent intent, int flags, int startId) {
	        return super.onStartCommand(intent, flags, startId);
	    }
	 
	}

</code></pre>

<h4 id="intent-service">Intent Service</h4>

<p><a href="http://developer.android.com/reference/android/app/IntentService.html" title="http://developer.android.com/reference/android/app/IntentService.html">IntentService</a>會產生一個額外的worker<br />
thread所以<strong>不需要</strong>在IntentService裡另外使用Thread或AsncTask，但也因為這樣，在IntentService裡做UI動作時，要確定是發生在MainThread</p>

<p>如果要在Intent Service裡對UI進行操作，可以透過Handler的機制</p>

<pre><code>public class MyService extends IntentService {
 
    public MyService() { 
      super("MyIntentService"); // constructor一定要有一個default的(無參數的)
    }
 
    private Handler handler = new Handler(); // 在這邊宣告的Handler，是attach在Main Thread上面的
 
    @Override
    protected void onHandleIntent(Intent intent) {
        // 透過attach在Main Thread上面的的handler post的method內的動作，可以對UI進行操作
        handler.post(new Runnable() {
            @Override
            public void run() {
                Toast.makeText(MyService.this, "Some Message" , Toast.LENGTH_SHORT).show();
            }
        });
    }
}

</code></pre>

<p>Intent Serivce的<code>onStartCommand()</code>實作如下，由實作可以知道Intent<br />
Service是用來處理一次性的服務，發一次intent，就把該intent要做的事做完後就停止service，而不是讓service一直在執行</p>

<pre><code>@Override
public int onStartCommand(Intent intent, int flags, int startId) {
    onStart(intent, startId);
    return mRedelivery ? START_REDELIVER_INTENT : START_NOT_STICKY;
}

</code></pre>

<h3 id="remote-service">Remote Service</h3>

<p>Remote<br />
Service跟寫一般RMI(RPC)的程式流程上差不多，定義interface(AIDL)，產生stub<br />
code，實作stub<br />
code，實作完是直接使用service，而不是透過intent呼叫。也跟一般的RMI一樣，你必須認真面對複雜型別的Serialization問題。</p>

<h2 id="bound-service">Bound Service</h2>

<p>Bound Service中的Bound的意思是要跟某個Activity”綁定”，也就是說，這個service的生命周期會受到Activity所控制。</p>

<ul>
  <li>binding是非同步的，也就是，service ready時，才會call back<br />
ServiceConnection.onServiceConnected() method;</li>
  <li>Binder不要宣告成非static的inner class，不然會發生service<br />
leaking的問題</li>
</ul>

<p>通用型的Local Service Binder,可適用於大部份的情況</p>

<pre><code>public class LocalBinder&lt;S&gt; extends Binder {
    private  WeakReference&lt;S&gt; service;
 
 
    public LocalBinder(S service){
        this.service = new WeakReference&lt;S&gt;(service);
    }
 
 
    public S getService() {
        return service.get();
    }
}

</code></pre>

<p>那何時需要用到Bound Service，通常是在</p>

<ol>
  <li>希望service的生命周期activity跟一致(一般的service啟動後，就會一直執在背景執行，直到收到stop或被系統kill)</li>
  <li>不希望service在沒預期的情況下被系統kill(系統會在資料不足情況下殺掉process，但可以透過<a href="http://developer.android.com/reference/android/app/Service.html#startForeground(int,%20android.app.Notification)" title="http://developer.android.com/reference/android/app/Service.html#startForeground(int, android.app.Notification)">startForeground()</a>來<strong>降低</strong>被殺掉的機率)</li>
  <li>希望在activity內可以直接對service進行更多操作 (local service要透過intent啟動，停止或進行其他command)</li>
</ol>

<h3 id="service-1">開機後自動啟動的Service</h3>

<p>開機後自動啟動的Service算是很常見的應用，很多的app都有這樣的需求，要達到這樣的功能，可以透過BroadcastReceiver去接收<code>android.intent.action.BOOT_COMPLETED</code>的系統事件，這個事件會在開機完成後被廣播一次。</p>

<pre><code>public class MyReceiver extends BroadcastReceiver {
 
    @Override
    public void onReceive(Context context, Intent intent) {
        Intent service = new Intent(context, MyService.class);
        context.startService(service);
    }
}

</code></pre>

<pre><code>        &lt;receiver android:name="MyReciever" &gt;
            &lt;intent filter="" &gt;
                &lt;action android:name="android.intent.action.BOOT_COMPLETED" /&gt;
            &lt;/intent&gt;
        &lt;/receiver&gt;
        &lt;uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" /&gt;

</code></pre>

<p>如果程式放在SD Card上，recive的xml設定檔還要去註冊<code>android.intent.action.ACTION_EXTERNAL_APPLICATIONS_AVAILABLE</code>，另外，在Android 3.0之後，程式至少要被執行過一次才會接到這個廣播事件。</p>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="http://www.ozdroid.com/#!BLOG/2010/12/19/How_to_make_a_local_Service_and_bind_to_it_in_Android" title="http://www.ozdroid.com/#!BLOG/2010/12/19/How_to_make_a_local_Service_and_bind_to_it_in_Android">http://www.ozdroid.com/#!BLOG/2010/12/19/How_to_make_a_local_Service_and_bind_to_it_in_Android</a> - service binding的介紹</li>
  <li><a href="http://developer.android.com/resources/articles/multitasking-android-way.html" title="http://developer.android.com/resources/articles/multitasking-android-way.html">http://developer.android.com/resources/articles/multitasking-android-way.html</a> - 關於android multitasking的介紹，可以更瞭解service的設計與使用的時機</li>
  <li><a href="http://www.vogella.de/articles/AndroidServices/article.html" title="http://www.vogella.de/articles/AndroidServices/article.html">http://www.vogella.de/articles/AndroidServices/article.html</a></li>
</ul>


  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Kent's Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Kent's Blog</li>
          <li><a href="mailto:kent.cwg@gmail.com">kent.cwg@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/kentchiu">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">kentchiu</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/kentchiu">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">kentchiu</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Kent的學習筆記</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
