<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width initial-scale=1">

  <title>Android Unit Test 101</title>
  <meta name="description" content="Table of contents">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://blog.kent-chiu.com//android/testing/2012/04/13/unit_testing_in_android.html">
  <link rel="alternate" type="application/atom+xml" title="Kent's Blog" href="http://blog.kent-chiu.com//feed.xml" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Kent's Blog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Android Unit Test 101</h1>
    <p class="post-meta">Apr 13, 2012 • Kent Chiu</p>
  </header>

  <article class="post-content">
    <h1 class="no_toc" id="table-of-contents">Table of contents</h1>

<ul id="markdown-toc">
  <li><a href="#section">準備工作</a></li>
  <li><a href="#android">Android測試架構</a>    <ul>
      <li><a href="#instrumentation-testing">Instrumentation Testing</a></li>
      <li><a href="#android-testing">Android Testing</a></li>
      <li><a href="#androidtestcase-or-instrumentationtestcase">AndroidTestCase Or InstrumentationTestCase</a>        <ul>
          <li><a href="#androidtestcase-vs-instrumentationtestcase">AndroidTestCase V.S InstrumentationTestCase</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#testcases">TestCases</a>    <ul>
      <li><a href="#androidtestcase">AndroidTestCase</a></li>
      <li><a href="#providertestcase2">ProviderTestCase2</a></li>
      <li><a href="#servicetestcase">ServiceTestCase</a>        <ul>
          <li><a href="#getcontext-vs-getsystemcontext">getContext() vs getSystemContext()</a></li>
        </ul>
      </li>
      <li><a href="#applicationtestcase">ApplicationTestCase</a></li>
      <li><a href="#instrumentationtestcase">InstrumentationTestCase</a></li>
      <li><a href="#activitytestcase">ActivityTestCase</a></li>
      <li><a href="#activityinstrumentationtestcase">ActivityInstrumentationTestCase</a></li>
      <li><a href="#activityinstrumentationtestcase2">ActivityInstrumentationTestCase2</a></li>
      <li><a href="#activityunittestcase">ActivityUnitTestCase</a></li>
      <li><a href="#providertestcase">ProviderTestCase</a></li>
      <li><a href="#singlelaunchactivitytestcase">SingleLaunchActivityTestCase</a></li>
      <li><a href="#syncbaseinstrumentation">SyncBaseInstrumentation</a></li>
    </ul>
  </li>
  <li><a href="#section-1">要測那些東西</a>    <ul>
      <li><a href="#activity-lifecycle-events">Activity lifecycle events</a></li>
      <li><a href="#content-provder">Content Provder</a></li>
      <li><a href="#listview-adapter">ListView Adapter</a></li>
      <li><a href="#database--file">Database &amp; File</a></li>
      <li><a href="#helper--utils">Helper &amp; Utils</a></li>
    </ul>
  </li>
  <li><a href="#test-helper">Test Helper</a>    <ul>
      <li><a href="#mock-objects">Mock Objects</a></li>
      <li><a href="#context-for-testing">Context For Testing</a>        <ul>
          <li><a href="#contextwrapper">ContextWrapper</a></li>
          <li><a href="#isolatedcontext">IsolatedContext</a></li>
          <li><a href="#renamingdelegatingcontext">RenamingDelegatingContext</a></li>
          <li><a href="#mockcontext">MockContext</a></li>
        </ul>
      </li>
      <li><a href="#assertion-classes">Assertion classes</a>        <ul>
          <li><a href="#misc">MISC</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#resources">Resources</a></li>
</ul>

<hr />

<p>這邊並不算真正的unit<br />
test，因為整個測試還是需要模擬器或實機執行，而且很依賴測試環境的context，如果有需要<br />
也是會去連網路或資料庫。</p>

<h1 id="section">準備工作</h1>

<p>要進行Android Testing通常是把test cases建立在另一個Test<br />
Project而不是像一般的java(maven base)目錄結構一樣<br />
在同一個project建立test folder.</p>

<p>Testing project可透過eclipse的android project<br />
wizard建立，建立後記得先把production project裡用到的lib export出來給test<br />
project使用</p>

<p><img src="http://blog.kent-chiu.com/images/2012-04-13/unit_testing_in_android_003.png" alt="unit_testing_in_android_003.png" /></p>

<p>而測試專案只需要放只有測試時會用到的lib，因為Tesing<br />
Project有reference到Production Project，所以會一併引用Production Project<br />
export 出來的lib。</p>

<p>一般習慣把被測的程式的專案叫Production<br />
project(或<a href="http://xunitpatterns.com/SUT.html" title="http://xunitpatterns.com/SUT.html">SUT</a>)，<br />
而測試程式專案叫Testing Project</p>

<h1 id="android">Android測試架構</h1>

<ul>
  <li>測試方式是透過建立測試專案來測試待測專案(<a href="http://xunitpatterns.com/SUT.html" title="http://xunitpatterns.com/SUT.html">SUT</a>)</li>
  <li>需啟動Android<br />
OS，所以是屬於整合測試，而不是單元測試(像是eclipse的plugin測試方式)</li>
  <li>需繼承特定的TestCase以便可以取得一些測試的基本功能</li>
</ul>

<p><img src="http://developer.android.com/images/testing/android_test_framework.png" alt="" /></p>

<p>Android應用程式跟測試程式透過Instrumentation Test<br />
Runner執行在同一個Process, 所以，在執行測試時，需透過Instrumentation<br />
Test Runner。</p>

<p><img src="http://blog.kent-chiu.com/images/2012-04-13/unit_testing_in_android_001.png" alt="unit_testing_in_android_001.png" /></p>

<p>測試分為兩大類</p>

<ol>
  <li>Instrumentation Testing</li>
  <li>Android Testing</li>
</ol>

<h3 id="instrumentation-testing">Instrumentation Testing</h3>

<p>這類型的testing會啟動instrumentation Test Runner。<br />
Instrumentation可以使用instrumentation framework，有了Instrumentation<br />
framework，可以透過Android的事件處理系統傳送訊息給Android應用程式，以便於模擬像”收到mail”，”收到簡訊”，”有電話calling進來”等等的動作，或者是對UI進行自動化測試。</p>

<pre><code>TestCase
 |
 `- InstrumentationTestCase
    |
    `- ActivityTestCase
    |  |
    |  `- ActivityInstrumentationTestCase&lt;T&gt;
    |  |
    |  `- ActivityInstrumentationTestCase2&lt;T&gt;
    |  |
    |  `- ActivityUnitTestCase&lt;T&gt;
    |
    `- ProviderTestCase&lt;T&gt;
    |
    `- SingleLaunchActivityTestCase&lt;T&gt;
    |
    `- SyncBaseInstrumentation

</code></pre>

<h3 id="android-testing">Android Testing</h3>

<p>提供Context給測試程式</p>

<p>以下的TestCase提供跟Android應用程式相關的Context，透過Context，可以取到Android的檔案系統，資料庫，資源檔…。</p>

<pre><code>TestCase
 |
 `- AndroidTestCase
    |
    `- ProviderTestCase2&lt;T&gt;
    |
    `- ServiceTestCase&lt;T&gt;
    |
    `- ApplicationTestCase&lt;T&gt;

</code></pre>

<p>XxxTestCase2&lt;T&gt;中的<code>tempalte &lt;T&gt;</code>在使用時要宣告成要被測試的class，就像泛型容器的用法一樣<br />
ex: <code>List&lt;MyClass&gt;</code></p>

<h3 id="androidtestcase-or-instrumentationtestcase">AndroidTestCase Or InstrumentationTestCase</h3>

<h5 id="androidtestcase-vs-instrumentationtestcase">AndroidTestCase V.S InstrumentationTestCase</h5>

<p>如果測試的對象是ui元件的話，那就必需要用InstrumentationTestCase體系的test<br />
cases，如果要測試non-UI的功能，像permissions之類的功能，那使用AndroidTestCase體系的的test<br />
case即可。<br />
@UiThreadTest(android.test.UiThreadTest)是使用在InstrumentationTestCase的test<br />
method上，用來標明該method會存取UI元件，需要在main thread執行。<br />
或者是，測試時需要使用到test project裡才有的resource(assets, res, …<br />
目錄下的東西)，那就得使用InstrumentationTestCase，因為InstrumentationTestCase才會去處理test<br />
project下的AndroidManifest.xml。</p>

<p>元件測試或應用程式測試，元件測試主要是以下三種</p>

<ol>
  <li><a href="http://developer.android.com/guide/topics/testing/activity_testing.html" title="http://developer.android.com/guide/topics/testing/activity_testing.html">Activity<br />
Testing</a></li>
  <li><a href="http://developer.android.com/guide/topics/testing/contentprovider_testing.html" title="http://developer.android.com/guide/topics/testing/contentprovider_testing.html">Content Provider<br />
Testing</a></li>
  <li><a href="http://developer.android.com/guide/topics/testing/service_testing.html" title="http://developer.android.com/guide/topics/testing/service_testing.html">Service<br />
Testing</a></li>
</ol>

<p>而應該程式測試測是測試<a href="http://developer.android.com/reference/android/app/Application.html" title="http://developer.android.com/reference/android/app/Application.html">Application</a></p>

<ol>
  <li><a href="http://developer.android.com/guide/topics/testing/service_testing.html" title="http://developer.android.com/guide/topics/testing/service_testing.html">ApplicationTestCase</a></li>
</ol>

<p><a href="http://developer.android.com/reference/android/test/TouchUtils.html" title="http://developer.android.com/reference/android/test/TouchUtils.html">TouchUtils</a><br />
(android.test.TouchUtils)可用來產生touch<br />
events，通常在InstrumentationTestCase or<br />
ActivityInstrumentationTestCase2中使用。</p>

<h1 id="testcases">TestCases</h1>

<ul>
  <li><a href="#androidtestcase" title="android:unit_testing_in_android ↵">AndroidTestCase</a>
    <ol>
      <li><a href="#providertestcase2" title="android:unit_testing_in_android ↵">ProviderTestCase2</a></li>
      <li><a href="#servicetestcase" title="android:unit_testing_in_android ↵">ServiceTestCase</a></li>
      <li><a href="#applicationtestcase" title="android:unit_testing_in_android ↵">ApplicationTestCase</a></li>
    </ol>
  </li>
  <li><a href="#instrumentationtestcase" title="android:unit_testing_in_android ↵">InstrumentationTestCase</a>
    <ol>
      <li><a href="#activitytestcase" title="android:unit_testing_in_android ↵">ActivityTestCase</a>
        <ol>
          <li><a href="#activityinstrumentationtestcase" title="android:unit_testing_in_android ↵">ActivityInstrumentationTestCase</a></li>
          <li><a href="#activityinstrumentationtestcase2" title="android:unit_testing_in_android ↵">ActivityInstrumentationTestCase2</a></li>
          <li><a href="#activityunittestcase" title="android:unit_testing_in_android ↵">ActivityUnitTestCase</a></li>
        </ol>
      </li>
      <li><a href="#providertestcase" title="android:unit_testing_in_android ↵">ProviderTestCase</a></li>
      <li><a href="#singlelaunchactivitytestcase" title="android:unit_testing_in_android ↵">SingleLaunchActivityTestCase</a></li>
      <li><a href="#syncbaseinstrumentation" title="android:unit_testing_in_android ↵">SyncBaseInstrumentation</a></li>
    </ol>
  </li>
</ul>

<h3 id="androidtestcase">AndroidTestCase</h3>

<p>提供context是在Android<br />
Framework中最重要的一個物件，在許多地方都會用到它，<code>這邊的context是test project的context</code>。<br />
AndroidTestCase啟動時，會先做自我檢測，先驗証測試環境是否ready to<br />
use.有提供幾個預先定義好的assert.</p>

<h3 id="providertestcase2">ProviderTestCase2</h3>

<p>測試Provider的test<br />
case,如果要測試資料而非UI的話，那測試的對象應該是<a href="http://developer.android.com/guide/topics/providers/content-providers.html" title="http://developer.android.com/guide/topics/providers/content-providers.html">Content<br />
Provider</a>及Content<br />
Provider用到的相關物件。</p>

<p>Android Test Framework有提供ProviderTestCase2可以Content<br />
Provider進行獨立的測試。使用方式如下：</p>

<pre><code>public class MyContentProviderTest extends ProviderTestCase2&lt;MyContentProvider&gt; {
 
    public MyContentProviderTest() {
        super(MyContentProvider.class, MyContentProvider.class.getName());
    }
 
    @Override
    protected void setUp() throws Exception {
        super.setUp();
    }
 
    public void testInsert() throws Exception {
        ContentValues values = new ContentValues();
        values.put("name", "foo");
        getProvider().insert("context://xxx/xx", values);
        // do assert here
    }
 
    public void testQuery() throws Exception {
        getProvider().query("context://xxx/xx", null, null, null, null);
        // do assert here
    }
}

</code></pre>

<p>此例中，測是對象為MyContentProvider,使用上要注意的有：</p>

<ol>
  <li>Testcase要繼承自<a href="http://developer.android.com/reference/android/test/ProviderTestCase2.html" title="http://developer.android.com/reference/android/test/ProviderTestCase2.html">ProviderTestCase2</a>
    <ul>
      <li>可以將<code>ProviderTestCase2&lt;T&gt;</code>的template<br />
&lt;T&gt;指定成對象為MyContentProvider，這樣可以testcase內就會引用MyContentProvider而非ContentProvider</li>
    </ul>
  </li>
  <li>必須要建立一個無參數的建構子(Constructor)</li>
  <li>Constructor裡必須呼叫<code>super(MyContentProvider.class, MyContentProvider.class.getName());</code>
    <ul>
      <li>因為MyContentProvider的Authority為<code>MyContentProvider.class.getName()</code></li>
    </ul>
  </li>
  <li>Testcase中透過getProvider()來取得MyContentProvider的instance，而不是自已創建MyContentProvider的instance</li>
</ol>

<h3 id="servicetestcase">ServiceTestCase</h3>

<p>ServiceTestCase可以用來測試Android Service,ServiceTestCase</p>

<p><img src="http://blog.kent-chiu.com/images/2012-04-13/unit_testing_in_android_002.png" alt="unit_testing_in_android_002.png" /></p>

<p>基本的使用方式如下：</p>

<ol>
  <li>宣告class時，把<code>template &lt;T&gt;</code>換成要被測試的Service(Service Under<br />
Test)</li>
  <li>建立default的constructor，並呼叫parent的constructor，代入class name</li>
  <li>setUp()時，ServiceTestCase會將real context儲存到systemContext</li>
  <li>透過startService()或bindService()啟動service<br />
(呼叫service.onCreate())</li>
  <li>test case的tearDown()會stop 跟 destroy service</li>
  <li>如果有需要的話，可以透過setCotext()或setApplication()換掉test<br />
case裡的context跟application.</li>
</ol>

<p>ServiceTestCase預設是使用MockApplication + Test Proejct的Context</p>

<pre><code>    public abstract class ServiceTestCase&lt;T extends Service&gt; extends AndroidTestCase {
        protected void setupService() {
            mService = null;
            try {
                mService = mServiceClass.newInstance();
            } catch (Exception e) {
                assertNotNull(mService);
            }
            if (getApplication() == null) {
                setApplication(new MockApplication());  // 使用mock版的Application()，而不是真正的
            }
            mService.attach(getContext(), null,  mServiceClass.getName(), null, getApplication(), null);
            assertNotNull(mService);
            mServiceId = new Random().nextInt();
            mServiceAttached = true;
        }
    } 

</code></pre>

<p>Android有提供<a href="#renamingdelegatingcontext" title="android:unit_testing_in_android ↵">RenamingDelegatingContext</a>,<br />
<a href="#contextwrapper" title="android:unit_testing_in_android ↵">ContextWrapper</a>,<br />
<a href="#isolatedcontext" title="android:unit_testing_in_android ↵">IsolatedContext</a>跟<a href="#mockcontext" title="android:unit_testing_in_android ↵">MockContext</a>來換原MockContext，也可以自已Mock一個</p>

<pre><code>public class MyServiceTest extends ServiceTestCase&lt;MyService&gt; {
    public MyServiceTest() {
        super(MyService.class);
    }
}

</code></pre>

<p><img src="http://blog.kent-chiu.com/images/2012-04-13/unit_testing_in_android_002.png" alt="unit_testing_in_android_002.png" /></p>

<p>ServiceTestCase提供<code>getService()</code>可以取得要被測試的service，<code>getSystemContext()</code>可以取得test<br />
project context</p>

<h5 id="getcontext-vs-getsystemcontext">getContext() vs getSystemContext()</h5>

<p>在預設的情況下，如果沒有特別去設定context，getContext(),getSystemContext()是同一個instance，但是<br />
如果有設定mock版的context，ex:<br />
<code>setConext(new MockContext());</code>，那麼getContext()會取到mock版的，<br />
而getSystemContext()會取到原來的(測試專案的)。</p>

<h3 id="applicationtestcase">ApplicationTestCase</h3>

<p>測試Application的test case</p>

<h3 id="instrumentationtestcase">InstrumentationTestCase</h3>

<h3 id="activitytestcase">ActivityTestCase</h3>

<h3 id="activityinstrumentationtestcase">ActivityInstrumentationTestCase</h3>

<h3 id="activityinstrumentationtestcase2">ActivityInstrumentationTestCase2</h3>

<h3 id="activityunittestcase">ActivityUnitTestCase</h3>

<h3 id="providertestcase">ProviderTestCase</h3>

<h3 id="singlelaunchactivitytestcase">SingleLaunchActivityTestCase</h3>

<h3 id="syncbaseinstrumentation">SyncBaseInstrumentation</h3>

<h1 id="section-1">要測那些東西</h1>

<h5 id="activity-lifecycle-events">Activity lifecycle events</h5>

<p>如果有在Activity lifecycle events像是onCreate(), onResume(), onPause(),<br />
…中保存activity的狀態，那麼應該要對這些methods進行測式，而當<br />
Configuration-changed事件發生時，也需要確定這些event的動作都正確。</p>

<p><img src="http://developer.android.com/images/activity_lifecycle.png" alt="" /></p>

<p>TestCase :<br />
<a href="#activityinstrumentationtestcase2" title="android:unit_testing_in_android ↵">ActivityInstrumentationTestCase2</a><br />
(大多數情況用這個),<br />
<a href="#activitytestcase" title="android:unit_testing_in_android ↵">ActivityTestCase</a>,<br />
<a href="#singlelaunchactivitytestcase" title="android:unit_testing_in_android ↵">SingleLaunchActivityTestCase</a></p>

<h5 id="content-provder">Content Provder</h5>

<p>Content<br />
Provder在大部份的情況下，不需要自行建立，也不建議直接建立，所以，Content<br />
Provder在測試時， Insert, Update, Query,<br />
Delete等method，還有getType()這些基本的methods都要被測到，如果沒有必要的話，<br />
儘量不要自已publish額外的method，因為在程式裡，只能取到ContentProvder型別，無法直接取得子型別(除非透過型別轉換，但不建議)，<br />
所以，ContentProvider的子類別，應儘量避免publish額外的API.</p>

<p>TestCase :<br />
<a href="#providertestcase2" title="android:unit_testing_in_android ↵">ProviderTestCase2</a></p>

<h5 id="listview-adapter">ListView Adapter</h5>

<p>ListView用的Adapter，ListView是UI裡很重要的一個元件，幾乎每個應該程式都會用到，而ListView<br />
Adapter又是ListView中 主要的元件，對Adapter測試的重要性，不言可喻。</p>

<pre><code>public class ScriptListAdapterTest extends AndroidTestCase {
 
    public void testExtractWords_none_words() throws Exception {
        ScriptListAdapter adapter = new ScriptListAdapter(getContext(), R.layout.script_list_item, R.id.scriptLine, ImmutableList.&lt;String&gt; of());
        adapter.setRichScript("foo bar");
        assertThat(adapter.extractWord(), Matchers.&lt;String&gt; emptyIterable());
    }
 
    public void testExtractWords_one_word() throws Exception {
        ScriptListAdapter adapter = new ScriptListAdapter(getContext(), R.layout.script_list_item, R.id.scriptLine, ImmutableList.&lt;String&gt; of());
        adapter.setRichScript("foo &lt;b&gt;bar&lt;/b&gt; baz");
        Iterable&lt;String&gt; words = adapter.extractWord();
        assertThat(words, hasItem("bar"));
    }
 
    public void testExtractWords_two_words() throws Exception {
        ScriptListAdapter adapter = new ScriptListAdapter(getContext(), R.layout.script_list_item, R.id.scriptLine, ImmutableList.&lt;String&gt; of());
        adapter.setRichScript("&lt;b&gt;foo&lt;/b&gt; bar &lt;b&gt;baz&lt;/b&gt;");
        Iterable&lt;String&gt; words = adapter.extractWord();
        assertThat(words, hasItems("foo", "baz"));
        assertThat(words, not(hasItem("bar")));
    }
 
    public void testRichText() throws Exception {
        ScriptListAdapter adapter = new ScriptListAdapter(getContext(), R.layout.script_list_item, R.id.scriptLine, ImmutableList.&lt;String&gt; of());
        CharSequence text = adapter.richText("this is a foo bar string", ImmutableList.of("foo", "string"));
        System.out.println(text);
 
    }
}

</code></pre>

<p>TestCase :<br />
<a href="#androidtestcase" title="android:unit_testing_in_android ↵">AndroidTestCase</a></p>

<h5 id="database--file">Database &amp; File</h5>

<p>我通常會對DatabaseHelper進行測試，以確定table可以正確的被建立或版更</p>

<pre><code>public class DatabaseHelperTest extends TestCase {
    private DatabaseHelper    helper;
    private SQLiteDatabase    db;
 
    @Override
    public void tearDown() {
        helper.close();
    }
 
    public void testDictionaryBankTable() throws Exception {
        Cursor c = db.query(DatabaseHelper.DICTIONARY_TABLE_NAME, null, null, null, null, null, null);
        assertEquals(4, c.getColumnCount());
    }
 
    public void testPodcastTable() throws Exception {
        Cursor c = db.query(DatabaseHelper.PODCAST_TABLE_NAME, null, null, null, null, null, null);
        assertEquals(13, c.getColumnCount());
    }
 
    public void testWordBankTable() throws Exception {
        Cursor c = db.query(DatabaseHelper.WORD_BANK_TABLE_NAME, null, null, null, null, null, null);
        assertEquals(2, c.getColumnCount());
    }
 
    @Override
    protected void setUp() throws Exception {
        super.setUp();
        db = SQLiteDatabase.create(null);
        helper = new DatabaseHelper(null, "podcast.db", null);
        helper.onOpen(db);
        helper.onCreate(db);
    }
}

</code></pre>

<p>TestCase: 沒有用到android 的context，只需用Junit內建的TestCase即可</p>

<h5 id="helper--utils">Helper &amp; Utils</h5>

<p>Helper跟Utils指的是跟Android比較無關類別，有可能用到網路或檔案系統等的class，可視情況選擇用TestCase,<br />
AndroidTestCase, InstrumentationTestCase<br />
通常我都是先用最簡單的，如果不適合，再找次簡單的。</p>

<h1 id="test-helper">Test Helper</h1>

<h3 id="mock-objects">Mock Objects</h3>

<p>Android Test Framework也有提供一列系的mock<br />
objects，如果在測試時採用Depedency Injection的方式把這些mock<br />
object注入，會讓測試更簡單，更獨立。 這些mock<br />
oject被放在<a href="http://developer.android.com/reference/android/test/mock/package-summary.html" title="http://developer.android.com/reference/android/test/mock/package-summary.html">android.test.mock<br />
package</a>內，主要有下列這些mock<br />
objects</p>

<ol>
  <li>MockApplication A mock Application class.</li>
  <li>MockContentProvider Mock implementation of ContentProvider.</li>
  <li>MockContentResolver An extension of ContentResolver that is designed<br />
for testing.</li>
  <li>MockContext A mock Context class.</li>
  <li>MockCursor A mock Cursor class that isolates the test code from real<br />
Cursor implementation.</li>
  <li>MockDialogInterface A mock DialogInterface class.</li>
  <li>MockPackageManager A mock PackageManager class.</li>
  <li>MockResources A mock Resources class.</li>
</ol>

<p>這些class採的mock<br />
strategy是stubbing而不是mocking，也就是說，使用時必須overwrite掉要提供資訊的methods</p>

<p>曾經試著將在Android test framework上使用幾個mock<br />
framework，都失敗了，目前都是直接使用Android test<br />
framework內建的mocks，雖不好用但可以接受。</p>

<ol>
  <li>mockito 1.8.5 - 無法通過編譯，殘念</li>
  <li>easymock 3 - extension的部份無法通過編譯，也就是只能mock<br />
interface，殘念</li>
  <li>powermock - 還是需要mocktio或easymock的jar，殘念</li>
  <li>jmock - 沒試</li>
</ol>

<p><a href="https://sites.google.com/site/androiddevtesting/" title="https://sites.google.com/site/androiddevtesting/">這裡</a>有篇文章說明為何大多數的Mock<br />
framework在Android上的無法正常動作， 只要是Mock<br />
Framework有用到CGLib就無法在Dalvik<br />
VM上執行，ex:EasyMock,Mockito都有用到這個lib</p>

<p>2012/3/16 己經有android team的member在將mockito<br />
porting到android上了，或許不久的將來就有android<br />
compatible的mockito可以用了 :) ，詳情 :<br />
<a href="http://code.google.com/p/mockito/issues/detail?id=308" title="http://code.google.com/p/mockito/issues/detail?id=308">http://code.google.com/p/mockito/issues/detail?id=308</a></p>

<h3 id="context-for-testing">Context For Testing</h3>

<p>Context的type hierarchy</p>

<p><img src="http://blog.kent-chiu.com/images/2012-04-13/unit_testing_in_android_002.png" alt="unit_testing_in_android_002.png" /></p>

<p>跟測試比較相關的有</p>

<ol>
  <li><a href="#contextwrapper" title="android:unit_testing_in_android ↵">ContextWrapper</a></li>
  <li><a href="#isolatedcontext" title="android:unit_testing_in_android ↵">IsolatedContext</a></li>
  <li><a href="#renamingdelegatingcontext" title="android:unit_testing_in_android ↵">RenamingDelegatingContext</a></li>
  <li><a href="#mockcontext" title="android:unit_testing_in_android ↵">MockContext</a></li>
</ol>

<h5 id="contextwrapper">ContextWrapper</h5>

<p>嚴格來說，這個並不算是testing專用的，其他不少context也是從這個開始繼承的，他的實作很簡單<br />
，就是把被wrapped的context的delegate給ContextWrapper，所以，每個method大多長這樣</p>

<pre><code>/**
 * Proxying implementation of Context that simply delegates all of its calls to
 * another Context.  Can be subclassed to modify behavior without changing
 * the original Context.
 */
public class ContextWrapper extends Context {
    Context mBase;

    @Override
    public AssetManager getAssets() {
        return mBase.getAssets();
    }

    @Override
    public Resources getResources()
    {
        return mBase.getResources();
    }

    @Override
    public PackageManager getPackageManager() {
        return mBase.getPackageManager();
    }
    ...
}

</code></pre>

<h5 id="isolatedcontext">IsolatedContext</h5>

<p>這個Context把跟設備相關的method改掉掉，讓context不與設備直接溝通，但又提供足夠的功能以測試可以進行。<br />
被IsolatedContext改寫掉的methods如下</p>

<p>(圖丟了 XD)</p>

<h5 id="renamingdelegatingcontext">RenamingDelegatingContext</h5>

<p>正常來說，如果production code裡用到的db 叫<br />
foo.db跟一個檔案叫bar.txt，但測試時，希望不要去動到原來的foo.db,bar.txt<br />
，而是提供一組測試用的foo.db跟bar.txt那就可以用RenamingDelegatingContext處理，可以把測試的命名成<br />
test_foo.db跟test_bar.txt，然後跟RenamingDelegatingContext測試用的contxt是以”test_”當prefix即可，這樣所有測試用的<br />
的檔案名稱跟DB名稱就是原來的名稱加上”test_”，用以避免prodcution<br />
code跟testing code互相感染。</p>

<p>RenamingDelegatingContext是用來處理檔案都是放在application<br />
project中的情況，但實際使用上，在測試專案上的相同的位置放上一個同檔名的檔案，會比用RenamingDelegatingContext適合，<br />
不過，如果取得測試案專案的resource，就得繼承自InstrumentationTestCase而非AndroidTestCase體系</p>

<h5 id="mockcontext">MockContext</h5>

<p>Mock版的Context，裡面的implement就是丟出UnsupportedOperationException，所以如果要用這個context，那<br />
測試中有用到的method，就要自行改寫，不然就等著接UnsupportedOperationException。</p>

<pre><code>/**
 * A mock {@link android.content.Context} class.  All methods are non-functional and throw 
 * {@link java.lang.UnsupportedOperationException}.  You can use this to inject other dependencies,
 * mocks, or monitors into the classes you are testing.
 */
public class MockContext extends Context {
 
    @Override
    public AssetManager getAssets() {
        throw new UnsupportedOperationException();
    }
 
    @Override
    public Resources getResources() {
        throw new UnsupportedOperationException();
    }
 
    @Override
    public PackageManager getPackageManager() {
        throw new UnsupportedOperationException();
    }
    ...
}

</code></pre>

<h3 id="assertion-classes">Assertion classes</h3>

<p>除了基本的Junit Assertions外，Android Test Framework還提供了</p>

<ol>
  <li><a href="http://developer.android.com/reference/android/test/MoreAsserts.html" title="http://developer.android.com/reference/android/test/MoreAsserts.html">More<br />
Asserts</a>
    <ul>
      <li>一些android testing<br />
assertions的延伸，不過我覺得<a href="http://wiki.kent-chiu.com/doku.php?id=java:hamcrest_101" title="java:hamcrest_101">hamcrest</a>更好用</li>
    </ul>
  </li>
  <li><a href="http://developer.android.com/reference/android/test/ViewAsserts.html" title="http://developer.android.com/reference/android/test/ViewAsserts.html">View<br />
Asserts</a>
    <ul>
      <li>一些跟view有關的assertions，像是view跟view之間的關係、對齊方式、…</li>
    </ul>
  </li>
</ol>

<p>目前Android Test Framework(Android<br />
2.3)還都是基於Junit3,Junit3的assertions在使用上沒有Junit4的來方便(powered<br />
by Hamcrest)，Junit3沒有內建<code>assertThat()</code>，<br />
Hamcrest的assertions是一個獨立的lib，所以，還是可以拿來跟Junit3搭著用，但是，Hamrcest的jar檔(1.3-R.C2)丟到Eclipse<br />
ADT時，無法順利通過編譯，<a href="http://wiki.kent-chiu.com/doku.php?id=java:hamcrest_101#hamcrest_android" title="java:hamcrest_101">這裡有提供解決的方式</a><br />
，至於Hamcrest的assertion，可以參閱<a href="http://code.google.com/p/hamcrest/wiki/Tutorial" title="http://code.google.com/p/hamcrest/wiki/Tutorial">Hamcrest網站的教學</a>或<a href="http://wiki.kent-chiu.com/doku.php?id=java:hamcrest_101" title="java:hamcrest_101">這裡</a>也有一個簡單的說明。</p>

<h4 id="misc">MISC</h4>

<ol>
  <li>RenamingDelegating - Product<br />
code用的是一個名字，測試時用的是另一個名字(檔案或資料庫)，用來避開testing<br />
code改到product code的內容</li>
  <li>ActivityMonitor -<br />
android.app.Instrumentation.ActivityMonitor是Instrumentation的內部類別，可以用來monitor系統的行為。</li>
</ol>

<p>如果test proejct跟production project有用到相同的jars，只需由production<br />
project export出jars讓testing project使用即可，如果testing<br />
project有跟production project相同的lib，可能compile time會出錯</p>

<h1 id="resources">Resources</h1>

<ul>
  <li><a href="http://developer.android.com/resources/tutorials/testing/helloandroid_test.html" title="http://developer.android.com/resources/tutorials/testing/helloandroid_test.html">Hello World<br />
Test</a></li>
  <li><a href="http://developer.android.com/guide/topics/testing/testing_android.html" title="http://developer.android.com/guide/topics/testing/testing_android.html">Testing and<br />
Instrumentation</a></li>
  <li><a href="http://developer.android.com/guide/developing/testing/testing_eclipse.html" title="http://developer.android.com/guide/developing/testing/testing_eclipse.html">Testing In Eclipse, with<br />
ADT</a></li>
  <li><a href="http://codinghard.wordpress.com/2009/06/04/a-first-look-at-the-android-testing-framework/" title="http://codinghard.wordpress.com/2009/06/04/a-first-look-at-the-android-testing-framework/">http://codinghard.wordpress.com/2009/06/04/a-first-look-at-the-android-testing-framework/</a></li>
  <li><a href="http://code.google.com/p/nativedriver/" title="http://code.google.com/p/nativedriver/">Native<br />
Driver</a>
    <ul>
      <li>google官方的ui test<br />
api，webdriver(<a href="http://code.google.com/p/selenium/" title="http://code.google.com/p/selenium/">selenium</a>)<br />
like的測試工具</li>
    </ul>
  </li>
  <li>RenamingDelegatingContext的使用方式可以參考下面的資料
    <ol>
      <li><a href="http://blog.jayway.com/2011/10/10/using-renamingdelegatingcontext-to-mock-contentresolver-in-android/" title="http://blog.jayway.com/2011/10/10/using-renamingdelegatingcontext-to-mock-contentresolver-in-android/">http://blog.jayway.com/2011/10/10/using-renamingdelegatingcontext-to-mock-contentresolver-in-android/</a></li>
      <li><a href="https://docs.google.com/View?id=ddwc44gs_21737cgtvfj" title="https://docs.google.com/View?id=ddwc44gs_21737cgtvfj">https://docs.google.com/View?id=ddwc44gs_21737cgtvfj</a></li>
    </ol>
  </li>
  <li><a href="http://www.slideshare.net/dtmilano/introduction-to-android-testing" title="http://www.slideshare.net/dtmilano/introduction-to-android-testing">http://www.slideshare.net/dtmilano/introduction-to-android-testing</a>
    <ul>
      <li>android testing的簡介投影片，有每個test case使用上的差異</li>
    </ul>
  </li>
</ul>


  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Kent's Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Kent's Blog</li>
          <li><a href="mailto:kent.cwg@gmail.com">kent.cwg@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/kentchiu">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">kentchiu</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/kentchiu">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">kentchiu</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Kent的學習筆記</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
